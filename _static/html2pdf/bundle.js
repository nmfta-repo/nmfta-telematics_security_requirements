var HTML2PDF4DOC;(()=>{"use strict";var e={d:(t,o)=>{for(var s in o)e.o(o,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:o[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{init:()=>P});const o={init:"[html2pdf]",pageDivider:"html2pdf-page",pageStartMarker:"[html2pdf-page-start]",contentFlowStart:"html2pdf-content-flow-start",contentFlowEnd:"html2pdf-content-flow-end",style:"[html2pdf-style]",footerTemplate:"[html2pdf-footer]",headerTemplate:"[html2pdf-header]",frontpageTemplate:"[html2pdf-frontpage]",frontpageContent:"html2pdf-frontpage",headerContent:"html2pdf-header",footerContent:"html2pdf-footer",pageNumberRoot:"[html2pdf-page-number]",pageNumberCurrent:"[html2pdf-page-number-current]",pageNumberTotal:"[html2pdf-page-number-total]",root:"html2pdf-root",paperFlow:"html2pdf-paper-flow",contentFlow:"html2pdf-content-flow",virtualPaper:"html2pdf-virtual-paper",virtualPaperTopMargin:"html2pdf-virtual-paper-margin-top",virtualPaperBottomMargin:"html2pdf-virtual-paper-margin-bottom",virtualPaperGap:"html2pdf-virtual-paper-gap",paperBody:"html2pdf-paper-body",paperHeader:"html2pdf-paper-header",paperFooter:"html2pdf-paper-footer",runningSafety:"html2pdf-print-running",printPageBreak:"html2pdf-print-page-break",printIgnore:"[html2pdf-print-ignore]",printHide:"[html2pdf-print-hide]",neutral:"html2pdf-neutral",word:"html2pdf-word",textNode:"html2pdf-text-node",textLine:"html2pdf-text-line",textGroup:"html2pdf-text-group",complexTextBlock:"html2pdf-complex-text-block",printForcedPageBreak:"html2pdf-print-forced-page-break",splitted:"[html2pdf-splitted]",processed:"[html2pdf-processed]",flagNoBreak:"[html2pdf-flag-no-break]",flagNoHanging:"[html2pdf-flag-no-hanging]",topCutPart:".html2pdf-top-cut",bottomCutPart:".html2pdf-bottom-cut",tocPageNumber:"html2pdf-toc-page-number"};class s{constructor({DOM:e,debugMode:t}){this.document=e,this.body=e.body,this._debugMode=t,this._debugToggler={_DOM:!1}}createElement(e){return this.document.createElement(e)}createDocumentFragment(){return this.document.createDocumentFragment()}cloneNode(e){return e?.cloneNode(!0)}cloneNodeWrapper(e){return e?.cloneNode(!1)}insertBefore(e,...t){e.before(...t)}insertAfter(e,...t){e.after(...t)}insertAtEnd(e,...t){e.append(...t)}insertAtStart(e,...t){e.prepend(...t)}insertInsteadOf(e,...t){e.before(...t),e.remove()}moveContent(e,t){for(;e.firstChild;)t.append(e.firstChild);console.assert(""===this.getInnerHTML(e))}removeNode(e){e.remove()}getElement(e,t=this.document){return t.querySelector(e)}getAllElements(e,t=this.document){return t.querySelectorAll(e)}getElementById(e,t=this.document){return t.getElementById(e)}getRightNeighbor(e){return e.nextElementSibling}getLeftNeighbor(e){return e.previousElementSibling}getParentNode(e){return e.parentElement}getNodeValue(e){return e.nodeValue}getLastElementChild(e){return e.lastElementChild}getFirstElementChild(e){return e.firstElementChild}getChildNodes(e){return e.childNodes}getChildren(e){return e.children}getElementOffsetParent(e){return e.offsetParent}getComputedStyle(e){return window.getComputedStyle(e)}getElementBCR(e){return e.getBoundingClientRect()}getElementOffsetLeft(e){return e?.offsetLeft}getElementOffsetHeight(e){return e?.offsetHeight}getElementOffsetWidth(e){return e?.offsetWidth}getElementOffsetTop(e){return e?.offsetTop}getElementOffsetBottom(e){return e.offsetTop+e.offsetHeight||void 0}getElementTagName(e){return e.tagName}getDataId(e){return e.dataset.id}getAttribute(e,t){if(!e||!t)return void(this._debugMode&&this._debugToggler._DOM&&console.warn("getAttribute() must have 2 params"));const o=t.charAt(0);if("."!==o&&"#"!==o||this._debugMode&&this._debugToggler._DOM&&console.log(`you're really sure ${t} is attribute selector?`),"["===o){this._debugMode&&this._debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);return e.getAttribute(o)}e.getAttribute(t)}setAttribute(e,t,o){if(!e||!t)return void(this._debugMode&&this._debugToggler._DOM&&console.warn("setAttribute() must have 2 params"));const s=t.charAt(0);if("."!==s)if("#"!==s)if("["!==s)this._debugMode&&this._debugToggler._DOM&&console.log(`you're really sure ${t} is a selector?`);else{this._debugMode&&this._debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const s=t.substring(1,t.length-1);e.setAttribute(s,o||"")}else{const o=t.substring(1);e.id=o}else{const o=t.substring(1);e.classList.add(o)}}setStyles(e,t){Object.entries(t).forEach((([t,o])=>e.style[t]=o))}addClasses(e,...t){e.classList.add(...t)}removeAttribute(e,t){if(!e||!t)return void(this._debugMode&&this._debugToggler._DOM&&console.warn("removeAttribute() must have 2 params"));const o=t.charAt(0);if(console.assert(o.match(/[a-zA-Z#\[\.]/),`removeAttribute() expects a valid selector, but received ${t}`),"."!==o)if("#"!==o)if("["!==o)e.removeAttribute(attr);else{this._debugMode&&this._debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);e.removeAttribute(o)}else{const o=t.substring(1);e.removeAttribute(o)}else{const o=t.substring(1);e.classList.remove(o)}}removeAllAttributes(e){for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name)}removeClasses(e,...t){e.classList.remove(...t)}removeAllClasses(e){e.classList=""}removeAllStyles(e){e.style=""}getInnerHTML(e){if("string"==typeof e){const t=this.document.querySelector(e);return t?t.innerHTML:void 0}return e.innerHTML}setInnerHTML(e,t){if("string"==typeof e){const o=this.document.querySelector(e);o&&(o.innerHTML=t)}e.innerHTML=t}isDocumentBody(e){return"BODY"===e.tagName}isTextNode(e){return e.nodeType===Node.TEXT_NODE}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}hasClass(e,t){return e.classList.contains(t)}hasID(e,t){return e.id===t}hasAttribute(e,t){return e.hasAttribute(t)}}class i{constructor(e){this.config=e,this.charWidth="10px"}create(){return this._baseStyle()+this._testStyle()}_baseStyle(){return`\n\n@page {\n  size: A4;\n  /* 2 values: width then height */\n  size: ${this.config.printWidth} ${this.config.printHeight};\n\n  margin-left: ${this.config.printLeftMargin};\n  margin-right: ${this.config.printRightMargin};\n  margin-top: ${this.config.printTopMargin};\n  margin-bottom: 0; /* hack */\n}\n\n${o.root} {\n  /* reset user styles */\n  display: block;\n\n  /* for proper printable flow positioning */\n  position: relative;\n\n  /* to compensate for possible BG in the parent node */\n  z-index: 1;\n\n  /* set print styles: affects previews */\n  margin: 0 auto;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  font-size: ${this.config.printFontSize};\n\n  /* protection against unpredictability of margins */\n  padding-top: .1px;\n  padding-bottom: calc(2 * ${this.config.virtualPagesGap});\n}\n\n${o.contentFlowStart},\n${o.contentFlowEnd},\n${o.pageDivider} {\n  display: block;\n}\n\n${o.virtualPaper} {\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: minmax(min-content, max-content) minmax(min-content, max-content) 1fr minmax(min-content, max-content) minmax(min-content, max-content);\n  place-items: stretch stretch;\n  place-content: stretch stretch;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  height: ${this.config.printHeight};\n  font-size: ${this.config.printFontSize};\n}\n\n${o.virtualPaper}::before {\n  position: absolute;\n  content: '';\n  width: ${this.config.printWidth};\n  height: ${this.config.printHeight};\n  left: -${this.config.printLeftMargin};\n  background-color: #fff;\n  box-shadow: rgba(0, 0, 0, 0.1) 2px 2px 12px 0px;\n  z-index: -1;\n}\n\n${o.paperFooter},\n${o.paperHeader} {\n  display: block;\n  position: relative;\n}\n\n${o.headerContent},\n${o.footerContent} {\n  display: block;\n  font-size: small;\n}\n\n${o.headerContent} p,\n${o.footerContent} p {\n  margin: 0;\n}\n\n${o.headerContent} {\n  padding-bottom: ${this.config.headerMargin};\n  /* padding-top: 1px; */\n  /* Page numbers: */\n  padding-top: 10px;\n}\n\n${o.footerContent} {\n  padding-top: ${this.config.footerMargin};\n  /* padding-bottom: 1px; */\n  /* Page numbers: */\n  min-height: 32px;\n}\n\n${o.tocPageNumber} {\n  min-width: 3ch;\n  display: flex;\n  justify-content: flex-end;\n  align-items: baseline;\n}\n\n${o.pageNumberRoot} {\n  display: flex;\n  column-gap: 2px;\n  position: absolute;\n  /* left: 100%; */\n  right: 0;\n  text-align: right;\n  line-height: 1;\n}\n\n${o.headerContent} ${o.pageNumberRoot} {\n  top: 0;\n}\n\n${o.footerContent} ${o.pageNumberRoot} {\n  bottom: 0;\n}\n\n${o.paperFlow} {\n  display: block;\n  position: absolute;\n  width: 100%;\n  z-index: -1;\n  /* affect only screen */\n  padding-bottom: 100px;\n}\n\n${o.contentFlow} {\n  display: block;\n}\n\n${o.runningSafety} {\n  display: block;\n  /*  ? should be checked and updated,\n        but in the meantime, bring back the common solution:\n     firefox ignores 0.1px size, so it's necessary to make a full-size pixel\n     and take it into account in the calculations:\n     padding-top: 1px;\n  */\n  padding-top: .1px;\n}\n\n${o.virtualPaperTopMargin} {\n  display: block;\n  height: ${this.config.printTopMargin};\n}\n\n${o.virtualPaperBottomMargin} {\n  display: block;\n  height: ${this.config.printBottomMargin};\n}\n\n${o.virtualPaperGap} {\n  display: block;\n  padding-top: ${this.config.virtualPagesGap};\n}\n\n${o.paperBody} {\n  display: block;\n}\n\n${o.frontpageContent} {\n  display: block;\n  transform-origin: top center;\n  padding: .1px;\n  height: 100%;\n}\n\n.null {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: 0;\n  color: transparent;\n  line-height: 0;\n  border: none;\n  outline: none;\n  background: none;\n  background-color: transparent;\n}\n\n${o.word},\n${o.textNode},\n${o.textLine},\n${o.textGroup},\n${o.neutral},\n${o.neutral} span {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: inherit;\n  color: inherit;\n  line-height: inherit;\n  background: none;\n  background-color: transparent;\n}\n\n${o.textGroup} {\n  display: block;\n}\n\n/*${o.splitted} ${o.textGroup} {\n  display: inline;\n}*/\n\n${o.complexTextBlock} > ${o.textLine} {\n  /* Firefox and inconsistent values of offset top for inline element */\n  display: inline-block;\n}\n\n${o.textGroup} ${o.textLine} {\n  display: inline;\n}\n\n${o.complexTextBlock} {\n  display: block;\n}\n\n${o.complexTextBlock} ${o.complexTextBlock} {\n  display: inline;\n}\n\n${o.printPageBreak} {\n  display: block;\n}\n\n${o.printForcedPageBreak} {\n  display: block;\n  visibility: hidden;\n  height: 0;\n  overflow: hidden;\n}\n\n@media print {\n  ${o.root} {\n    /* to prevent a blank last page */\n    padding: 0;\n  }\n\n  ${o.paperFlow} {\n    padding-bottom: 0;\n  }\n\n  ${o.contentFlow} {\n    -webkit-mask-image: none !important;\n            mask-image: none !important;\n  }\n\n  ${o.printIgnore} {\n    display: contents;\n  }\n\n  ${o.printHide},\n  ${o.virtualPaper}::before,\n  ${o.virtualPaperTopMargin},\n  ${o.virtualPaperBottomMargin},\n  ${o.virtualPaperGap} {\n    display: none;\n  }\n\n  ${o.virtualPaper} {\n    break-inside: avoid;\n    height: auto;\n  }\n\n  ${o.paperBody} {\n    break-inside: avoid;\n  }\n\n  ${o.printPageBreak} {\n    break-after: page;\n    padding: .1px;\n  }\n\n  ${o.printForcedPageBreak} {\n    /* JUST MANUAL! */\n    /* break-after: page; */\n  }\n\n  ${o.flagNoBreak} {\n    /*\n    TODO: temporary commented!\n    When splitting blocks, printPageBreak falls INTO this element,\n    and in Firefox it causes a blank page.\n    FIX the split of complex blocks and check in Firefox.\n    */\n    /* break-inside: avoid-page; */\n  }\n}\n\n/* arrangement */\n${o.topCutPart} {\n  margin-top: 0 !important;\n  border-top: none !important;\n}\n${o.bottomCutPart} {\n  margin-bottom: 0 !important;\n  border-bottom: none !important;\n}\n    `}_testStyle(){return this.config.debugMode?`\n/* FOR TEST */\n${o.virtualPaperGap} {\n  background: #ff000020;\n}\n\n${o.paperFooter},\n${o.paperHeader} {\n  background: #fa96ff20;\n}\n${o.paperBody} {\n  background: #ffee0020;\n}\n${o.runningSafety} {\n  background: #f200ff;\n}\n${o.frontpageContent} {\n  background: #00fcff20;\n}\n\n${o.neutral} {\n  background: #00ffee10;\n}\n\n${o.textNode} {\n  background: #00ff0010;\n}\n\n${o.textGroup},\n${o.textLine} {\n  background: #0000ff08;\n}\n\n    `:""}}class n{constructor({config:e,DOM:t,node:o,selector:s}){this.success=!1,this.root,this.paperFlow,this.contentFlow,this.frontpageTemplate,this.headerTemplate,this.footerTemplate,this._initialRoot,this._contentRoot,this._config=e,this._debugMode=e.debugMode,this._DOM=t,this._selector=s,this._node=o,this._customInitialRootSelector=e.initialRoot,this._defaultInitialRootSelector=s.init}create(){if(this._getTemplates(),this._insertStyle(),this._DOM.getElement(`style${this._selector.style}`)){if(this._createLayout(),this._DOM.getParentNode(this.root)!==this._initialRoot||this._DOM.getElementOffsetParent(this.paperFlow)!==this.root||this._DOM.getElementOffsetParent(this.contentFlow)!==this.root)return console.assert(this._DOM.getParentNode(this.root)===this._initialRoot,"Failed to insert the layout root into the DOM."),console.assert(this._DOM.getElementOffsetParent(this.paperFlow)===this.root,"Failed to insert the paperFlow element into the DOM."),void console.assert(this._DOM.getElementOffsetParent(this.contentFlow)===this.root,"Failed to insert the contentFlow element into the DOM.");this.success=!0}else console.error("Failed to add print styles into the DOM.")}_getTemplates(){console.assert(this._selector.frontpageTemplate,"frontpageTemplate selector is missing"),console.assert(this._selector.headerTemplate,"headerTemplate selector is missing"),console.assert(this._selector.footerTemplate,"footerTemplate selector is missing"),this.frontpageTemplate=this._DOM.getInnerHTML(this._selector.frontpageTemplate),this.headerTemplate=this._DOM.getInnerHTML(this._selector.headerTemplate),this.footerTemplate=this._DOM.getInnerHTML(this._selector.footerTemplate)}_insertStyle(){const e=this._DOM.getElement("head"),t=this._DOM.body;if(!e&&!t)return void console.error("Check the structure of your document. We didn`t find HEAD and BODY tags. HTML2PDF4DOC expects valid HTML.");const o=this._node.create("style",new i(this._config).create());o?(this._DOM.setAttribute(o,this._selector.style,""),e?this._DOM.insertAtEnd(e,o):t?this._DOM.insertBefore(t,o):console.assert(!1,"We expected to find the HEAD and BODY tags.")):console.error("Failed to create print styles")}_createLayout(){this._getInitialRoot(),this._initialRoot?(this._debugMode&&console.log("initial root:",this._initialRoot),this._createRoot(),this._createPaperFlow(),this._createContentFlow(),this._DOM.moveContent(this._initialRoot,this.contentFlow),this._DOM.insertAtEnd(this._initialRoot,this.root),this._DOM.insertAtEnd(this.root,this.paperFlow,this.contentFlow),this._insertContentFlowStartAndEnd(this.contentFlow),this._ignoreUnprintableEnvironment(this.root)):console.error("Failed to initialize the root element.")}_insertContentFlowStartAndEnd(e){const t=this._node.create(this._selector.contentFlowStart),o=this._node.create(this._selector.contentFlowEnd);return this._DOM.insertAtStart(e,t),this._DOM.insertAtEnd(e,o),{contentFlowStart:t,contentFlowEnd:o}}_getInitialRoot(){let e=this._customInitialRootSelector?this._DOM.getElement(this._customInitialRootSelector):this._DOM.getElement(this._defaultInitialRootSelector);if(!e){if(!this._DOM.body)return void console.error("We expected to find the BODY tag.");e=this._DOM.body,console.warn(`The printable area is currently unspecified and encompasses the entire contents of the BODY tag. To restrict the printed content to a specific area, include ${this._defaultInitialRootSelector} in the root element of the desired printing area.`)}return this._initialRoot=e,e}_createRoot(){const e=this._node.create(this._selector.root);return this.root=e,e}_createPaperFlow(){const e=this._node.create(this._selector.paperFlow);return this.paperFlow=e,e}_createContentFlow(){const e=this._node.create(this._selector.contentFlow);return this.contentFlow=e,e}_ignoreUnprintableEnvironment(e){if(e===this._DOM.body)return void console.assert(!1,"misshapen root");let t=this._DOM.getParentNode(e);this._DOM.setAttribute(t,this._selector.printIgnore),this._DOM.getChildNodes(t).forEach((t=>{if(t!==e&&this._DOM.isElementNode(t))this._DOM.setAttribute(t,this._selector.printHide);else{if(!this._node.isSignificantTextNode(t))return;this._DOM.setAttribute(this._node.wrapTextNode(t),this._selector.printHide)}})),this._DOM.isDocumentBody(t)||this._ignoreUnprintableEnvironment(t)}}class r{constructor({config:e,DOM:t,selector:o}){this._config=e,this._DOM=t,this._selector=o,this._debugMode=this._config.debugMode,this._markupDebugMode=this._config.markupDebugMode}get(e,t=this._DOM){return console.assert(e),this._DOM.getElement(e,t)}getAll(e,t=this._DOM){return console.assert(e),"string"==typeof e&&(e=e.split(",").filter(Boolean)),console.assert(Array.isArray(e),"Selectors must be provided as an array or string (one selector or multiple selectors, separated by commas). Now the selectors are:",e),console.assert(e.length>0,"getAll(selectors), selectors:",e),1===e.length?[...this._DOM.getAllElements(e[0],t)]:[...e].flatMap((e=>[...this._DOM.getAllElements(e,t)]))}getTableEntries(e){const t=[...e.children].reduce(((e,t)=>{const o=t.tagName;return"TBODY"===o?{...e,rows:[...e.rows,...t.children]}:"CAPTION"===o?(this.setFlagNoBreak(t),{...e,caption:t}):"COLGROUP"===o?(this.setFlagNoBreak(t),{...e,colgroup:t}):"THEAD"===o?(this.setFlagNoBreak(t),{...e,thead:t}):"TFOOT"===o?(this.setFlagNoBreak(t),{...e,tfoot:t}):"TR"===o?{...e,rows:[...e.rows,...t]}:{...e,unexpected:[...e.unexpected,...t]}}),{caption:null,thead:null,tfoot:null,rows:[],unexpected:[]});return t.unexpected.length>0&&this._debugMode&&console.warn(`something unexpected is found in the table ${e}`),t}getPreparedChildren(e){if(this.isComplexTextBlock(e))return[...this._DOM.getChildren(e)];{let t=[...this._DOM.getChildNodes(e)].reduce(((e,t)=>{if(this.isSTYLE(t))return e;if(this.isSignificantTextNode(t))return e.push(this.wrapTextNode(t)),e;if(!this._DOM.getElementOffsetParent(t)){const o=this.getPreparedChildren(t);return o.length>0&&e.push(...o),e}return this._DOM.isElementNode(t)?(e.push(t),e):void 0}),[]);return this.isVerticalFlowDisrupted(t)&&(t=this._processInlineChildren(t)),t}}_processInlineChildren(e){let t=null;const o=[];return e.forEach((e=>{this.isInline(this._DOM.getComputedStyle(e))?(t||(t=this.createComplexTextBlock(),this.wrapNode(e,t),o.push(t)),this._DOM.insertAtEnd(t,e)):(t=null,o.push(e))})),o}clearTemplates(e){this.getAll("template",e).forEach((e=>this._DOM.removeNode(e)))}isSelectorMatching(e,t){if(!e||!t)return void(this._debugMode&&console.warn("isSelectorMatching() must have 2 params","\n element: ",e,"\n selector: ",t));const o=t.charAt(0);if("."===o){const o=t.substring(1);return this._DOM.hasClass(e,o)}if("#"===o){const o=t.substring(1);return this._DOM.hasID(e,o)}if("["===o){this._debugMode&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);return this._DOM.hasAttribute(e,o)}return this._DOM.getElementTagName(e)===t.toUpperCase()}isSignificantTextNode(e){return!!this._DOM.isTextNode(e)&&this._DOM.getNodeValue(e).trim().length>0}isSTYLE(e){return"STYLE"===this._DOM.getElementTagName(e)}isIMG(e){return"IMG"===this._DOM.getElementTagName(e)}isSVG(e){return"svg"===this._DOM.getElementTagName(e)}isOBJECT(e){return"OBJECT"===this._DOM.getElementTagName(e)}isLiNode(e){return"LI"===this._DOM.getElementTagName(e)}isNeutral(e){return this.isSelectorMatching(e,this._selector.neutral)}isWrappedTextNode(e){return this.isSelectorMatching(e,this._selector.textNode)}isWrappedTextLine(e){return this.isSelectorMatching(e,this._selector.textLine)}isWrappedTextGroup(e){return this.isSelectorMatching(e,this._selector.textGroup)}isPageStartElement(e){return this.isSelectorMatching(e,this._selector.pageStartMarker)}isContentFlowEnd(e){return this.isSelectorMatching(e,this._selector.contentFlowEnd)}isComplexTextBlock(e){return this.isSelectorMatching(e,this._selector.complexTextBlock)}isNoBreak(e,t=this._DOM.getComputedStyle(e)){return this.isSelectorMatching(e,this._selector.flagNoBreak)||this.isWrappedTextLine(e)||this.isWrappedTextGroup(e)||this.isInlineBlock(t)||this.notSolved(e)}isNoHanging(e){return this.isSelectorMatching(e,this._selector.flagNoHanging)}isForcedPageBreak(e){return this.isSelectorMatching(e,this._selector.printForcedPageBreak)}isInline(e){const t=e.display;return"inline"===t||"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}isInlineBlock(e){const t=e.display;return"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}isGrid(e){return"grid"===e.display}isTableLikeNode(e,t=this._DOM.getComputedStyle(e)){return"TABLE"!==this._DOM.getElementTagName(e)&&["table"].includes(t.display)}isTableNode(e,t=this._DOM.getComputedStyle(e)){return"TABLE"===this._DOM.getElementTagName(e)||["table"].includes(t.display)}isPRE(e,t=this._DOM.getComputedStyle(e)){return["block"].includes(t.display)&&["pre","pre-wrap","pre-line","break-spaces","nowrap"].includes(t.whiteSpace)}isGridAutoFlowRow(e){const t=e.display,o=e.gridAutoFlow;return("grid"===t||"inline-grid"===t)&&"row"===o}isFullySPlitted(e){const t=this._DOM.getComputedStyle(e);return this.isPRE(e,t)||this.isTableNode(e,t)||this.isTableLikeNode(e,t)||this.isGridAutoFlowRow(t)}isFirstChildOfFirstChild(e,t){if(!e||!this._DOM.getParentNode(e))return!1;let o=e;for(;this._DOM.getParentNode(o)&&o!==t;){if(this._DOM.getFirstElementChild(this._DOM.getParentNode(o))!==o)return!1;o=this._DOM.getParentNode(o)}return o===t}isLastChildOfLastChild(e,t){if(!e||!this._DOM.getParentNode(e))return!1;let o=e;for(;this._DOM.getParentNode(o)&&o!==t;){if(this._DOM.getParentNode(o)===t){let e=this._DOM.getRightNeighbor(o);for(;!this._DOM.getElementOffsetHeight(e)&&!this._DOM.getElementOffsetWidth(e);)if(e=this._DOM.getRightNeighbor(e),this.isContentFlowEnd(e))return!0;return this.isContentFlowEnd(e)}if(this._DOM.getLastElementChild(this._DOM.getParentNode(o))!==o)return!1;o=this._DOM.getParentNode(o)}return o===t}isLineChanged(e,t){return this._DOM.getElementOffsetTop(t)-this._DOM.getElementOffsetBottom(e)>-2}isLineKept(e,t,o){const s=this._DOM.getElementOffsetBottom(e),i=this._DOM.getElementOffsetTop(t),n=s-i,r=n>=2;return o&&console.group("isLineKept?"),o&&console.log("\n",r,"\n","\n currentBottom",s,[e],"\n nextTop",i,[t],"\n delta",n),o&&console.groupEnd("isLineKept?"),r}findFirstChildParent(e,t){let o=this._DOM.getParentNode(e),s=null;for(;o&&o!==t;){if(e!==this._DOM.getFirstElementChild(o))return s;s=o,e=o,o=this._DOM.getParentNode(e)}return s}findLastChildParent(e,t){let o=this._DOM.getParentNode(e),s=null;for(;o&&o!==t;){if(e!==this._DOM.getLastElementChild(o))return s;s=o,e=o,o=this._DOM.getParentNode(e)}return s}isVerticalFlowDisrupted(e){return e.some(((e,t,o)=>{const s=e,i=o[t+1];if(!i)return!1;return this._DOM.getElementOffsetBottom(s)>this._DOM.getElementOffsetTop(i)}))}findAllForcedPageBreakInside(e){return this.getAll(this._selector.printForcedPageBreak,e)}findPreviousNoHangingsFromPage(e,t,o){let s=null,i=this._DOM.getLeftNeighbor(e);for(;i&&this.getTop(i,o)>t;){if(!this.isNoHanging(i))return s;if(this.isPageStartElement(i))return e;s=i,e=i,i=this._DOM.getLeftNeighbor(e)}return s}insertForcedPageBreakBefore(e){const t=this.create(this._selector.printForcedPageBreak);return this._DOM.insertBefore(e,t),t}insertForcedPageBreakAfter(e){const t=this.create(this._selector.printForcedPageBreak);return this._DOM.insertAfter(e,t),t}replaceNodeContentsWith(e,...t){this._DOM.setInnerHTML(e,""),this._DOM.insertAtEnd(e,...t)}fitElementWithinBoundaries({element:e,height:t,width:o,vspace:s,hspace:i}){const n=s/t,r=i/o,l=n<r?n:r,a=Math.trunc(t*l),g=Math.trunc(o*l);this._DOM.setStyles(e,{height:a+"px",width:g+"px"}),this._DOM.setAttribute(e,"height",`${a}px`),this._DOM.setAttribute(e,"width",`${g}px`)}create(e,t){let o;if(e){const t=e.charAt(0);if(t.match(/[#\[\.]/))o=this._DOM.createElement("div"),this._DOM.setAttribute(o,e);else{if(!t.match(/[a-zA-Z]/))return void console.assert(!1,"Expected valid html selector ot tag name, but received:",e);o=this._DOM.createElement(e)}}else o=this._DOM.createElement("div");return t&&this._DOM.setInnerHTML(o,t),o}createNeutral(){return this.create(this._selector.neutral)}createTextLine(){return this.create(this._selector.textLine)}createTextGroup(){return this.create(this._selector.textGroup)}createWithFlagNoBreak(e){const t=this.create(this._selector.flagNoBreak);return e&&this._DOM.setStyles(t,e),t}createPrintPageBreak(){return this.create(this._selector.printPageBreak)}createComplexTextBlock(){return this.create(this._selector.complexTextBlock)}createTestNodeFrom(e){const t=this._DOM.cloneNodeWrapper(e);return this._DOM.setAttribute(t,".test-node"),this._DOM.setStyles(t,{position:"absolute",background:"rgb(255 239 177)",width:this.getMaxWidth(e)+"px"}),t}createWord(e,t){const o=this.create(this._selector.word);return this._DOM.setInnerHTML(o,e),o.dataset.index=t,o}createSignpost(e,t=24){const o=this.create();return this._DOM.setStyles(o,{display:"flex",flexWrap:"nowrap",alignItems:"center",justifyContent:"center",textAlign:"center",fontSize:"8px",fontFamily:"sans-serif",letterSpacing:"1px",textTransform:"uppercase",height:t+"px"}),e&&this._DOM.setInnerHTML(o,e),o}createTable({wrapper:e,caption:t,colgroup:o,thead:s,tfoot:i,tbody:n}){const r=e||this.create("table"),l=this.create("TBODY");return t&&this._DOM.insertAtEnd(r,t),o&&this._DOM.insertAtEnd(r,o),s&&this._DOM.insertAtEnd(r,s),n&&this._DOM.insertAtEnd(l,...n),this._DOM.insertAtEnd(r,l),i&&this._DOM.insertAtEnd(r,i),r}markProcessed(e,t){this._markupDebugMode&&this._DOM.setAttribute(e,this._selector.processed,"🏷️ "+t)}setFlagNoBreak(e){this._DOM.setAttribute(e,this._selector.flagNoBreak)}setFlagNoHanging(e){this._DOM.setAttribute(e,this._selector.flagNoHanging)}markPageStartElement(e,t){this._DOM.setAttribute(e,this._selector.pageStartMarker,t)}unmarkPageStartElement(e){this._DOM.removeAttribute(e,this._selector.pageStartMarker)}markPartNodesWithClass(e){e.forEach((e=>{this._DOM.setAttribute(e,this._selector.topCutPart),this._DOM.setAttribute(e,this._selector.bottomCutPart)})),this._DOM.removeAttribute(e.at(0),this._selector.topCutPart),this._DOM.removeAttribute(e.at(-1),this._selector.bottomCutPart)}wrapNode(e,t){this._DOM.insertBefore(e,t),this._DOM.insertAtEnd(t,e)}wrapTextNode(e){if(!this.isSignificantTextNode(e))return;const t=this.create(this._selector.textNode);return this._DOM.insertBefore(e,t),this._DOM.insertAtEnd(t,e),t}getTop(e,t=null,o=0){if(!e)return void(this._debugMode&&console.warn("element must be provided, but was received:",e,"\nThe function returned:",void 0));if(null===t)return this._DOM.getElementOffsetTop(e);if(!t)return void(this._debugMode&&console.warn("root must be provided, but was received:",t,"\nThe function returned:",void 0));const s=this._DOM.getElementOffsetParent(e);if(!s)return void(this._debugMode&&console.warn("Element has no offset parent.","\n element:",[e],"\n offsetParent:",s,"\n The function returned:",void 0));const i=this._DOM.getElementOffsetTop(e);return s===t?i+o:this.getTop(s,t,o+i)}getBottom(e,t=null){if(e){if(null===t)return this._DOM.getElementOffsetBottom(e);if(t)return this.getTop(e,t)+this._DOM.getElementOffsetHeight(e);this._debugMode&&console.warn("root must be provided, but was received:",t,"\nThe function returned:",void 0)}else this._debugMode&&console.warn("element must be provided, but was received:",e,"\nThe function returned:",void 0)}getHeightWithMargin(e){const t=parseInt(this._DOM.getComputedStyle(e).marginTop),o=parseInt(this._DOM.getComputedStyle(e).marginBottom);return this._DOM.getElementOffsetHeight(e)+t+o}getBottomWithMargin(e,t){const o=this.create();e&&this._DOM.insertAfter(e,o);const s=e?this.getTop(o,t):void 0;return this._DOM.removeNode(o),s}getTopWithMargin(e,t){const o=parseInt(this._DOM.getComputedStyle(e).marginTop);return this.getTop(e,t)-o}getMaxWidth(e){const t=this.create();this._DOM.insertAtEnd(e,t);const o=this._DOM.getElementOffsetWidth(t);return this._DOM.removeNode(t),o}getEmptyNodeHeight(e,t=!0){const o=this.create();t&&this._DOM.setStyles(o,{padding:"0.1px"});const s=this._DOM.cloneNodeWrapper(e);"TABLE"===this._DOM.getElementTagName(e)&&this._DOM.setInnerHTML(s,"<tr><td></td></tr>"),this._DOM.insertAtEnd(o,s),this._DOM.insertBefore(e,o);const i=this._DOM.getElementOffsetHeight(o);return this._DOM.removeNode(o),i}getLineHeight(e){const t=this.createNeutral();this._DOM.setInnerHTML(t,"!"),this._DOM.setStyles(t,{display:"block"}),this._DOM.insertAtEnd(e,t);const o=this._DOM.getElementOffsetHeight(t);return this._DOM.removeNode(t),o}getTableRowHeight(e,t=0){const o=this._DOM.getElementOffsetTop(e),s=this._DOM.cloneNode(e),i="!<br />".repeat(t);[...s.children].forEach((e=>this._DOM.setInnerHTML(e,i))),this._DOM.insertBefore(e,s);const n=this._DOM.getElementOffsetTop(e);return this._DOM.removeNode(s),n-o}copyNodeWidth(e,t){this._DOM.setStyles(e,{width:`${this._DOM.getElementOffsetWidth(t)}px`,"min-width":`${this._DOM.getElementOffsetWidth(t)}px`})}lockTableWidths(e){this.copyNodeWidth(e,e),this.getAll("td",e).forEach((e=>this.copyNodeWidth(e,e)))}prepareSplittedNode(e){const t=e,o=this.splitByWordsGreedy(e),s=o.map((e=>{const t=this._DOM.createElement("span");return this._DOM.setInnerHTML(t,e+" "),t})),i=this.createTestNodeFrom(e);return this._DOM.insertAtEnd(i,...s),this._DOM.insertAtEnd(e,i),{splittedNode:t,nodeWords:o,nodeWordItems:s}}splitByLinesGreedy(e){return e.split(/(?<=\n)/)}splitByWordsGreedy(e){return(this._DOM.getNodeValue(e)||this._DOM.getInnerHTML(e)).split(/(?<=\s|-)/)}splitByWordsGreedyWithSpacesFilter(e){return(this._DOM.getNodeValue(e)||this._DOM.getInnerHTML(e)).trim().split(/(?<=\s|-)/).filter((e=>" "!=e))}notSolved(e){this._DOM.getElementTagName(e);return!1}}function l(e){return e?.length?e?.split(/\s+/).filter(Boolean):[]}class a{constructor({config:e,DOM:t,node:o,selector:s}){this._debugMode=e.debugMode,this._DOM=t,this._selector=s,this._node=o,this._debugToggler=this._debugMode,this._minParagraphLeftLines=2,this._minParagraphDanglingLines=2,this._minParagraphBreakableLines=this._minParagraphLeftLines+this._minParagraphDanglingLines||2}init(){console.log("🚨 init Paragraph")}split(e){return this._splitComplexTextBlockIntoLines(e)}_getLines(e){return Math.ceil(this._DOM.getElementOffsetHeight(e)/this._node.getLineHeight(e))}_splitComplexTextBlockIntoLines(e){if(this._debugToggler&&console.group("_splitComplexTextBlockIntoLines",[e]),this._node.isSelectorMatching(e,this._selector.splitted))return this._end(this._selector.splitted),this._DOM.getChildren(e);const t=this._node.getPreparedChildren(e),o=t.map((e=>{const t=this._node.getLineHeight(e),o=this._DOM.getElementOffsetHeight(e),s=this._DOM.getElementOffsetLeft(e),i=this._DOM.getElementOffsetTop(e);return{element:e,lines:Math.ceil(o/t),left:s,top:i,height:o,lineHeight:t,text:this._DOM.getInnerHTML(e)}}));this._debugToggler&&console.log("\n🚸 nodeChildren",[...t],"\n🚸 extendedChildrenArray",[...o]);const s=o.flatMap((e=>e.lines>1&&!this._node.isNoBreak(e.element)?this._breakItIntoLines(e.element):e.element));this._debugToggler&&console.log("\n🚸🚸🚸\n partiallyLinedChildren",[...s]);const i=s.reduce(((e,t,o,s)=>(e||(e=[]),"BR"===this._DOM.getElementTagName(t)?(e.at(-1).push(t),e.push([]),this._debugToggler&&console.log("br; push:",t),e):!e.length||this._node.isLineChanged(e.at(-1).at(-1),t)?(e.push([t]),this._debugToggler&&console.log("◼️ start new line:",t),e):0===e.at(-1).length||e.length&&this._node.isLineKept(e.at(-1).at(-1),t)?(this._debugToggler&&console.log("⬆ add to line:",t),e.at(-1).push(t),e):void(this._debugToggler&&console.assert(!0,"groupedPartiallyLinedChildren: An unexpected case of splitting a complex paragraph into lines.","\nOn the element:",t)))),[]);if(this._debugToggler&&console.log("🟡🟡🟡 groupedPartiallyLinedChildren \n",i.length,[...i]),i.length<this._minParagraphBreakableLines)return this._debugToggler&&console.log("groupedPartiallyLinedChildren.length < this._minParagraphBreakableLines",i.length,"<",this._minParagraphBreakableLines),this._end("NOT _splitComplexTextBlockIntoLines"),[];const n=i.slice(0,this._minParagraphLeftLines).flat(),r=i.slice(-this._minParagraphDanglingLines).flat();this._debugToggler&&console.log("groupedPartiallyLinedChildren",[...i],"\n","minLeftLines =",this._minParagraphLeftLines,"\n",n,"\n","minDanglingLines =",this._minParagraphDanglingLines,"\n",r),i.splice(0,this._minParagraphLeftLines,n),i.splice(-this._minParagraphDanglingLines,this._minParagraphDanglingLines,r);const l=i.map(((e,t)=>{let o;if(0==e.length)o=e[0],o.setAttribute("role","🚫"),console.assert(0==e.length,"The string cannot be empty (_splitComplexTextBlockIntoLines)");else if(1==e.length)o=e[0];else{o=this._node.createTextGroup(),this._DOM.insertBefore(e[0],o),this._DOM.insertAtEnd(o,...e)}return o.dataset.child=t,o}));return this._end("OK _splitComplexTextBlockIntoLines"),this._DOM.setAttribute(e,this._selector.splitted),l}_breakItIntoLines(e){if(this._debugToggler&&console.group("_breakItIntoLines",[e]),this._node.isNoBreak(e))return this._end("isNoBreak"),e;if(this._node.isWrappedTextNode(e)){const t=this._breakWrappedTextNodeIntoLines(e);return this._end("TextNode newLines"),t}return this._end("(recursive _breakItIntoLines)"),this._processNestedInlineElements(e)}_processNestedInlineElements(e){this._debugToggler&&console.group("_processNestedInlineElements",[e]);const t=this._getNestedInlineChildren(e).flatMap((e=>this._getLines(e)>1?this._breakItIntoLines(e):e)),o=this._findNewLineStarts(t),s=o.map(((s,i)=>{const n=t[s],r=t[o[i+1]];return this._cloneAndCleanOutsideRange(e,n,r)}));return this._DOM.insertInsteadOf(e,...s),this._end("Nested Inline parts"),s}_cloneAndCleanOutsideRange(e,t,o){t&&t.setAttribute("split","start"),o&&o.setAttribute("split","end");let s=e.cloneNode(!0);if(t){let t=s.querySelector('[split="start"]'),o=t.previousElementSibling;for(;o;){let e=o;o=o.previousElementSibling,e.remove()}let i=t.parentElement;for(;i&&i!==e;){let e=i.previousElementSibling;for(;e;){let t=e;e=e.previousElementSibling,t.remove()}i=i.parentElement}t.removeAttribute("split")}if(o){let t=s.querySelector('[split="end"]'),o=t.nextElementSibling;for(;o;){let e=o;o=o.nextElementSibling,e.remove()}let i=t.parentElement;for(;i&&i!==e;){let e=i.nextElementSibling;for(;e;){let t=e;e=e.nextElementSibling,t.remove()}i=i.parentElement}t.remove()}return t&&t.removeAttribute("split"),o&&o.removeAttribute("split"),s}_getNestedInlineChildren(e){return[...this._DOM.getChildNodes(e)].reduce(((e,t)=>{if(this._node.isSignificantTextNode(t))return e.push(this._node.wrapTextNode(t)),e;if(!this._DOM.getElementOffsetParent(t)){const o=this._node.getPreparedChildren(t);return o.length>0&&e.push(...o),e}if(this._DOM.isElementNode(t)){return this._getNestedInlineChildren(t).forEach((t=>e.push(t))),e}}),[])}_makeWordsFromTextNode(e){const t=this._node.splitByWordsGreedy(e);this._debugToggler&&console.log("wordArray",t);const o=t.map(((e,t)=>this._node.createWord(e+"",t)));return this._debugToggler&&console.log("wrappedWordArray",o),{wordArray:t,wrappedWordArray:o}}_breakWrappedTextNodeIntoLines(e){e.classList.add("🔠_breakItIntoLines");const{wordArray:t,wrappedWordArray:o}=this._makeWordsFromTextNode(e);this._DOM.setInnerHTML(e,""),this._DOM.insertAtEnd(e,...o);const s=this._findNewLineStarts(o),i=s.reduce(((o,i,n)=>{const r=this._node.createTextLine(),l=s[n],a=s[n+1],g=" "+t.slice(l,a).join("")+" ";return this._DOM.setInnerHTML(r,g),this._DOM.insertBefore(e,r),o.push(r),o}),[]);return e.remove(),i}_findNewLineStarts(e){return e.reduce(((t,o,s)=>(s>0&&e[s-1].offsetTop+e[s-1].offsetHeight<=o.offsetTop&&t.push(s),t)),[0])}_end(e){this._debugToggler&&console.log(`%c ▲ ${e} `,"background:#eee;color:#888;padding: 0 1px 0 0;"),this._debugToggler&&console.groupEnd()}}const g="#66CC00",d=`color: ${g};font-weight:bold`,h=`border:1px solid ${g};background:#EEEEEE;color:${g};`,c="background:#999;color:#FFF;padding: 0 4px;";class _{constructor({config:e,DOM:t,node:o,selector:s,layout:i,referenceWidth:n,referenceHeight:r}){this._debugMode=e.debugMode,this._debugToggler={_parseNode:!1,_parseNodes:!1,_registerPageStart:!1,_getProcessedChildren:!1,_splitPreNode:!1,_splitTableNode:!1,_splitTableLikeNode:!1,_splitTableRow:!1,_splitGridNode:!1,_createSlicesBySplitFlag:!1,_getInternalBlockSplitters:!1},this._selector=s,this._node=o,this._noHangingSelectors=l(e.noHangingSelectors),this._pageBreakBeforeSelectors=l(e.pageBreakBeforeSelectors),this._pageBreakAfterSelectors=l(e.pageBreakAfterSelectors),this._forcedPageBreakSelectors=l(e.forcedPageBreakSelectors),this._noBreakSelectors=l(e.noBreakSelectors),this._garbageSelectors=l(e.garbageSelectors),this._DOM=t,this._paragraph=new a({config:e,DOM:t,node:o,selector:s}),this._paragraph.init(),this._root=i.root,this._contentFlow=i.contentFlow,this._referenceWidth=n,this._referenceHeight=r,this._minLeftLines=2,this._minDanglingLines=2,this._minBreakableLines=this._minLeftLines+this._minDanglingLines,this._minLeftRows=1,this._minDanglingRows=1,this._minBreakableRows=this._minLeftRows+this._minDanglingRows,this._minPreFirstBlockLines=3,this._minPreLastBlockLines=3,this._minPreBreakableLines=this._minPreFirstBlockLines+this._minPreLastBlockLines,this._minBreakableGridRows=4,this._imageReductionRatio=.8,this._signpostHeight=24,this._commonLineHeight=this._node.getLineHeight(this._root),this._minimumBreakableHeight=this._commonLineHeight*this._minBreakableLines,this._isFirefox="undefined"!=typeof InstallTrigger,this.pages=[]}calculate(){return this._removeGarbageElements(),this._prepareForcedPageBreakElements(),this._prepareNoBreakElements(),this._prepareNoHangingElements(),this._calculate(),this._debugMode&&console.log("%c ✔ Pages.calculate()",h,this.pages),this.pages}_removeGarbageElements(){if(this._garbageSelectors.length){this._node.getAll(this._garbageSelectors,this._contentFlow).forEach((e=>{this._DOM.removeNode(e)}))}}_prepareNoHangingElements(){if(this._noHangingSelectors.length){this._node.getAll(this._noHangingSelectors,this._contentFlow).forEach((e=>{this._node.setFlagNoHanging(e);const t=this._node.findLastChildParent(e,this._contentFlow);t&&this._node.setFlagNoHanging(t)}))}}_prepareNoBreakElements(){if(this._noBreakSelectors.length){this._node.getAll(this._noBreakSelectors,this._contentFlow).forEach((e=>this._node.setFlagNoBreak(e)))}}_prepareForcedPageBreakElements(){const e=this._pageBreakBeforeSelectors.length?this._node.getAll(this._pageBreakBeforeSelectors,this._contentFlow):[],t=this._pageBreakAfterSelectors.length?this._node.getAll(this._pageBreakAfterSelectors,this._contentFlow):[],o=this._node.getAll(this._forcedPageBreakSelectors,this._contentFlow);this._node.isFirstChildOfFirstChild(e[0],this._contentFlow)&&e.shift(),this._node.isLastChildOfLastChild(t.at(-1),this._contentFlow)&&t.pop(),e.length&&e.forEach((e=>{const t=this._node.findFirstChildParent(e,this._contentFlow);t&&(e=t),this._node.insertForcedPageBreakBefore(e)})),o&&o.forEach((e=>{if(!this._node.isForcedPageBreak(e)){const t=this._node.findFirstChildParent(e,this._contentFlow);t&&(e=t),this._node.insertForcedPageBreakBefore(e)}})),t.length&&t.forEach((e=>{const t=this._node.findLastChildParent(e,this._contentFlow);t&&(e=t),this._node.isForcedPageBreak(e.nextElementSibling)||this._node.insertForcedPageBreakAfter(e)}))}_calculate(){this._debugMode&&console.groupCollapsed("•• init data ••"),this._debugMode&&console.log("this._referenceHeight",this._referenceHeight,"\n","this._noHangingSelectors",this._noHangingSelectors,"\n","this._pageBreakBeforeSelectors",this._pageBreakBeforeSelectors,"\n","this._pageBreakAfterSelectors",this._pageBreakAfterSelectors,"\n","this._forcedPageBreakSelectors",this._forcedPageBreakSelectors,"\n","this._noBreakSelectors",this._noBreakSelectors,"\n","isFirefox",this._isFirefox),this._debugMode&&console.groupEnd("•• init data ••"),this._registerPageStart(this._node.get(this._selector.contentFlowStart,this._contentFlow));const e=this._node.getBottomWithMargin(this._contentFlow,this._root);if(e<this._referenceHeight)return this._debugMode&&console.log(`contentFlow (${e}) fits on the page (${this._referenceHeight})`),void this._node.findAllForcedPageBreakInside(this._contentFlow).forEach((e=>this._registerPageStart(e)));const t=this._node.getPreparedChildren(this._contentFlow);this._debugMode&&console.groupCollapsed("%c🚸 children(contentFlow)",h),this._debugMode&&console.log(t),this._debugMode&&console.groupEnd("%c🚸 children(contentFlow)",h),this._parseNodes({array:t})}_registerPageStart(e,t=!1){if(t){e=this._node.findFirstChildParent(e,this._contentFlow)||e;e=this._node.findPreviousNoHangingsFromPage(e,this._node.getTop(this.pages.at(-1)?.pageStart,this._root),this._root)||e}const o=this._node.getTopWithMargin(e,this._root)+this._referenceHeight;this.pages.push({pageStart:e,pageBottom:o}),this._node.markPageStartElement(e,this.pages.length),this._debugMode&&this._debugToggler._registerPageStart&&console.log(`%c📍register page ${this.pages.length}`,"background:yellow;font-weight:bold","\n  pageBottom:",o,"\n  pageStart:",e)}_parseNodes({array:e,previous:t,next:o,parent:s,parentBottom:i}){this._debugMode&&this._debugToggler._parseNodes&&console.log("🔵 _parseNodes","\narray:",[...e],"\ntracedParent:",s);for(let n=0;n<e.length;n++)this._parseNode({previousElement:e[n-1]||t,currentElement:e[n],nextElement:e[n+1]||o,isCurrentFirst:0==n&&!e[n-1],parent:s,parentBottom:n===e.length-1?i:void 0})}_parseNode({isCurrentFirst:e,previousElement:t,currentElement:o,nextElement:s,parent:i,parentBottom:n}){const r=["%c_parseNode\n","color:white"];if(this._debugMode&&this._debugToggler._parseNode&&console.group("%c_parseNode",d,""+(n?"★last★":"regular")),this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"3 nodes: ",{previousElement:t,currentElement:o,nextElement:s},"\n","\ncurrent: ",o,"\nparent: ",i,"\nisCurrentFirst: ",e),this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"parent:",i,"\n","parentBottom:",n,"\n","isCurrentFirst:",e,"\n","parent:",i,"\n"),!s)return this._node.markProcessed(o,"content-flow-end"),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (!nextElement)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd());const l=n||this._node.getBottomWithMargin(o,this._root),a=this.pages.at(-1).pageBottom;if(this.pages.at(-1).pageStart===o&&(this._node.isNoBreak(o)||l<=a))return this._node.markProcessed(o,"node is already registered and fits in the page"),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (node is already registered and fits in the next page)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd());if(this._node.isForcedPageBreak(o))return this._registerPageStart(o),this._node.markProcessed(o,"node is ForcedPageBreak"),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (isForcedPageBreak)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd());this._debugMode&&console.assert(this._DOM.getElementOffsetParent(o),"it is expected that the element has an offset parent",o);const g=this._node.getTop(s,this._root);if(this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"• newPageBottom",a,"\n","• nextElementTop",g),g<=a)this._debugMode&&this._debugToggler._parseNode&&console.log("nextElementTop <= newPageBottom",g,"<=",a),this._node.markProcessed(o,"node fits"),this._node.findAllForcedPageBreakInside(o).forEach((e=>{this._node.markProcessed(e,"node is ForcedPageBreak (inside a node that fits)"),this._registerPageStart(e)}));else{if(this._debugMode&&this._debugToggler._parseNode&&console.log("nextElementTop > newPageBottom",g,">",a),this._node.isSVG(o)||this._node.isIMG(o)||this._node.isOBJECT(o)){const e=this._node.isSVG(o)?this._node.createSignpost(o):o;let t=i?a-this._node.getTop(e,this._root):a-this._node.getTop(i,this._root);t-=n?n-this._node.getBottom(e,this._root):0;let r=this._referenceHeight-(i?this._node.getTop(e,this._root)-this._node.getTop(i,this._root):0);const l=this._DOM.getElementOffsetHeight(e),g=this._DOM.getElementOffsetWidth(e);if(this._debugMode&&this._debugToggler._parseNode&&console.log("🖼️🖼️🖼️🖼️🖼️🖼️\n",`H-space: ${t}, image Height: ${l}, image Width: ${g}`,o,"\n parent",i,"parentBottom",n),l<this._referenceWidth&&this._debugMode&&this._debugToggler._parseNode&&console.warn("%c IMAGE is too wide","color: red"),l<t)return this._node.markProcessed(o,"IMG that fits, and next starts on next"),this._registerPageStart(s),this._debugMode&&this._debugToggler._parseNode&&console.log("Register next elements; 🖼️🖼️🖼️ IMG fits:",o),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode 🖼️ IMG fits",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd());const d=t/l;return d>this._imageReductionRatio?(this._debugMode&&this._debugToggler._parseNode&&console.log("Register next elements; 🖼️🖼️🖼️ IMG RESIZE to availableImageNodeSpace:",t,o),this._node.markProcessed(o,`IMG with ratio ${d}, and next starts on next`),this._node.fitElementWithinBoundaries({element:o,height:l,width:g,vspace:t,hspace:this._referenceWidth}),this._registerPageStart(s),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode 🖼️ IMG scaled",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd())):(this._node.markProcessed(o,"IMG starts on next"),this._registerPageStart(e,!0),this._debugMode&&this._debugToggler._parseNode&&console.log("🖼️ register Page Start",o),l>r&&(this._node.fitElementWithinBoundaries({element:o,height:l,width:g,vspace:r,hspace:this._referenceWidth}),this._node.markProcessed(o,"IMG starts on next and resized"),this._debugMode&&this._debugToggler._parseNode&&console.log("🖼️ ..and fit it to full page",o)),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd()))}if(o.style.height){this._debugMode&&this._debugToggler._parseNode&&console.log("🥁 currentElement has HEIGHT",o.style.height);const e=this._node.getTop(o,this._root),t=a-e,i=g-e,n=t/i,r=this._referenceHeight/i;return this._debugMode&&this._debugToggler._parseNode&&console.log("\n🥁 currentElementTop",e,"\n🥁 newPageBottom",a,"\n🥁 availableSpace",t,"\n🥁 currentElementContextualHeight",i,"\n🥁 availableSpaceFactor",n,"\n🥁 fullPageFactor",r),console.assert(n<1),n>.8?(this._debugMode&&this._debugToggler._parseNode&&console.log("🥁 availableSpaceFactor > 0.8: ",n),this._DOM.setStyles(o,{transform:`scale(${n})`}),this._registerPageStart(s),this._node.markProcessed(o,"processed as a image, has been scaled down within 20%, the next one starts a new page"),this._node.markProcessed(s,"the previous one was scaled down within 20%, and this one starts a new page."),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (has height & scale)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd())):(r<1&&(this._debugMode&&this._debugToggler._parseNode&&console.log("🥁 fullPageFactor < 1: ",r),this._node.markProcessed(o,"processed as a image, has been scaled down, and starts new page"),this._DOM.setStyles(o,{transform:`scale(${r})`})),this._debugMode&&this._debugToggler._parseNode&&console.log("🥁 _registerPageStart",o),this._registerPageStart(o),this._node.markProcessed(o,"processed as a image, starts new page"),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (has height & put on next page)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd()))}if(this._debugMode&&this._debugToggler._parseNode&&console.log("split or not? \n","currentElementBottom",l),l<=a)return this._debugMode&&this._debugToggler._parseNode&&console.log("currentElementBottom <= newPageBottom",l,"<=",a,"\n register nextElement as pageStart"),this._node.isNoHanging(o)?(this._debugMode&&this._debugToggler._parseNode&&console.log("currentElement fits / last, and _isNoHanging => move it to the next page"),this._node.markProcessed(o,"it fits & last & _isNoHanging => move it to the next page"),this._registerPageStart(o,!0),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (isNoHanging)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd())):(this._registerPageStart(s),this._node.markProcessed(o,"fits, its bottom falls exactly on the cut"),this._node.markProcessed(s,"starts new page, its top is exactly on the cut"),this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode (currentElement fits, register the next element)",c),void(this._debugMode&&this._debugToggler._parseNode&&console.groupEnd()));this._debugMode&&this._debugToggler._parseNode&&console.log("currentElementBottom > newPageBottom",l,">",a);const d=this._getProcessedChildren(o,a,this._referenceHeight);this._debugMode&&this._debugToggler._parseNode&&console.log("try to break it and loop the children:",d);const h=d.length;this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"childrenNumber ",h),this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"currentElement ",o);const _=e&&i||o;if(h){const e=this._node.isFullySPlitted(o);this._parseNodes({array:d,previous:t,next:s,parent:e?void 0:_,parentBottom:e?void 0:l}),this._node.markProcessed(o,"getProcessedChildren and _parseNodes")}else this._node.isNoHanging(t)?(this._registerPageStart(t,!0),this._node.markProcessed(o,"doesn't fit, has no children, isNoHanging(previousElement)"),this._node.markProcessed(t,"isNoHanging - register it or parents")):(this._debugMode&&this._debugToggler._parseNode&&console.log(...r,"_registerPageStart (from _parseNode): \n",o),this._registerPageStart(o,!0),this._node.markProcessed(o,"doesn't fit, has no children, register it or parents"))}this._debugMode&&this._debugToggler._parseNode&&console.log("%c END _parseNode",c),this._debugMode&&this._debugToggler._parseNode&&console.groupEnd()}_getProcessedChildren(e,t,o){const s=["%c_getProcessedChildren\n","color:white"];let i=[];if(this._node.isNoBreak(e))return this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"🧡 isNoBreak",e),[];if(this._node.isComplexTextBlock(e))return this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 ComplexTextBlock",e),this._paragraph.split(e)||[];if(this._node.isWrappedTextNode(e))return this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 TextNode",e),this._paragraph.split(e)||[];const n=this._DOM.getComputedStyle(e);return this._node.isTableLikeNode(e,n)?(this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 TABLE like",e),i=this._splitTableLikeNode(e,t,o,n)||[]):this._node.isTableNode(e,n)?(this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 TABLE",e),i=this._splitTableNode(e,t,o,n)||[]):this._node.isPRE(e,n)?(this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 PRE",e),i=this._splitPreNode(e,t,o)||[]):this._node.isGridAutoFlowRow(this._DOM.getComputedStyle(e))?(this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💜 GRID"),i=this._splitGridNode(e,t,o)||[]):(this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"💚 some node",e),i=this._node.getPreparedChildren(e),this._debugMode&&this._debugToggler._getProcessedChildren&&console.info(...s,"🚸 get element children ",i)),i}_splitPreNode(e,t,o,s){const i=s||this._DOM.getComputedStyle(e),n=["%c_splitPreNode\n","color:white"];this._debugMode&&this._debugToggler._splitPreNode&&console.group("%c_splitPreNode","background:cyan"),this._debugMode&&this._debugToggler._splitPreNode&&console.log(...n,"node",e);const r=this._node.getTop(e,this._root),l=this._DOM.getElementOffsetHeight(e),a=this._node.getLineHeight(e),g=this._node.getEmptyNodeHeight(e,!1);if(l<g+a*this._minPreBreakableLines)return this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode (small node)",c),[];const d=this._DOM.getChildNodes(e);if(this._debugMode&&this._debugToggler._splitPreNode&&console.log("_children:",d.length),0==d.length)return this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode (not breakable)",c),[];if(d.length>1)return this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode TODO!",c),[];{if(this._DOM.isElementNode(d[0])){const e=d[0];return this._debugMode&&this._debugToggler._splitPreNode&&console.warn("is Element Node",e),this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode ???????",c),[]}this._node.isWrappedTextNode(d[0])&&this._debugMode&&this._debugToggler._splitPreNode&&console.warn(`is TEXT Node: ${d[0]}`);const s=d[0].wholeText,l=this._node.splitByLinesGreedy(s);if(l.length<this._minPreBreakableLines)return this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode few lines",c),[];const a=l.splice(0,this._minPreFirstBlockLines).join(""),h=l.splice(-this._minPreLastBlockLines).join("");l.unshift(a),l.push(h);const _=l.map((e=>{const t=this._node.createWithFlagNoBreak();return this._DOM.setInnerHTML(t,e),t}));this._debugMode&&this._debugToggler._splitPreNode&&console.log("linesFromNode",_),this._node.replaceNodeContentsWith(e,..._);const p=o-g;let u=0,b=[],m=t-r-g;const f=i.position;"relative"!=f&&this._DOM.setStyles(e,{position:"relative"});for(let t=0;t<_.length;t++){const o=_[t];this._node.getBottom(o,e)>m&&(t&&b.push(t),t&&(u+=1),m=t?this._node.getTop(o,e)+p:p)}if(this._DOM.setStyles(e,{position:f}),!b.length)return this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode NO SPLIITERS",c),[];b.push(null),this._debugMode&&this._debugToggler._splitPreNode&&console.log(...n,"splitters",b);const M=b.map(((t,o,s)=>{const i=this._DOM.cloneNodeWrapper(e);this._node.setFlagNoBreak(i);const n=s[o-1]||0,r=t||s[s.length];return this._DOM.insertAtEnd(i,..._.slice(n,r)),i}));return this._node.markPartNodesWithClass(M),this._debugMode&&this._debugToggler._splitPreNode&&console.log(...n,"newPreElementsArray",M),this._node.replaceNodeContentsWith(e,...M),this._DOM.setStyles(e,{display:"contents"}),this._DOM.setAttribute(e,"[slough-node]",""),this._DOM.removeAllClasses(e),this._debugMode&&this._debugToggler._splitPreNode&&console.log("%c END _splitPreNode",c),this._debugMode&&this._debugToggler._splitPreNode&&console.groupEnd(),M}}_insertTableSplit({startId:e,endId:t,table:o,tableEntries:s}){const i=this._DOM.cloneNodeWrapper(o),n=s.rows.slice(e,t),r=this._node.createWithFlagNoBreak();return o.before(r),e&&this._DOM.insertAtEnd(r,this._node.createSignpost("(table continued)",this._signpostHeight)),this._DOM.insertAtEnd(r,this._node.createTable({wrapper:i,colgroup:this._DOM.cloneNode(s.colgroup),caption:this._DOM.cloneNode(s.caption),thead:this._DOM.cloneNode(s.thead),tbody:n}),this._node.createSignpost("(table continues on the next page)",this._signpostHeight)),r}_splitTableLikeNode(e,t,o,s){const i=s||this._DOM.getComputedStyle(e),n=this._node.getPreparedChildren(e),r=this._node.getTop(e,this._root),l=this._node.getEmptyNodeHeight(e),a=o-l;let g=n,d=0,h=[],c=t-r-l;const _=i.position;"relative"!=_&&this._DOM.setStyles(e,{position:"relative"});for(let t=0;t<g.length;t++){const o=g[t];this._node.getBottom(o,e)>c&&(t&&h.push(t),t&&(d+=1),c=t?this._node.getTop(o,e)+a:a)}if(this._DOM.setStyles(e,{position:_}),!h.length)return this._debugMode&&this._debugToggler._splitTableLikeNode&&console.log("splitters.length",h.length),[];h.push(null);const p=h.map(((t,o,s)=>{const i=this._DOM.cloneNodeWrapper(e);this._node.setFlagNoBreak(i),this._node.unmarkPageStartElement(i);const n=s[o-1]||0,r=t||s[s.length];return this._DOM.insertAtEnd(i,...g.slice(n,r)),i}));return this._node.markPartNodesWithClass(p),this._node.replaceNodeContentsWith(e,...p),this._DOM.removeAllClasses(e),this._DOM.removeAllStyles(e),this._DOM.setStyles(e,{display:"contents"}),this._DOM.setAttribute(e,"[slough-node]",""),p}_splitTableNode(e,t,o){const s=["%c_splitTableNode\n","color:white"];this._debugMode&&this._debugToggler._splitTableNode&&console.time("_splitTableNode"),this._debugMode&&this._debugToggler._splitTableNode&&console.group("%c_splitTableNode","background:cyan"),this._node.lockTableWidths(e);const i=this._node.getEmptyNodeHeight(e),n=this._node.getTableEntries(e);this._debugMode&&this._debugToggler._splitTableNode&&console.log(...s,e,"\ntableEntries",n);const r=this._node.getTopWithMargin(e,this._root),l=this._DOM.getElementOffsetHeight(n.caption)||0,a=this._DOM.getElementOffsetHeight(n.thead)||0,g=this._DOM.getElementOffsetHeight(n.tfoot)||0,d=(l??0)*(this._isFirefox??0),h=t-r-i-this._signpostHeight,_=o-l-a-g-i-2*this._signpostHeight;this._debugMode&&this._debugToggler._splitTableNode&&console.log(...s,"\n • tableFirstPartBottom",h,"\n","\n   pageBottom",t,"\n - tableTop",r,"\n - tableCaptionHeight",l,"\n - tableTheadHeight",a,"\n - tableWrapperHeight",i,"\n - this._signpostHeight",this._signpostHeight,"\n","\n   fullPageHeight",o,"\n - tableCaptionHeight",l,"\n - tableTheadHeight",a,"\n - tableTfootHeight",g,"\n - 2 * this._signpostHeight",2*this._signpostHeight,"\n - tableWrapperHeight",i,"\n = tableFullPartContentHeight",_);const p=e=>[...e.rows,...e.tfoot?[e.tfoot]:[]];let u=p(n),b=[],m=h;this._debugMode&&this._debugToggler._splitTableNode&&console.log(this._node.getTop(u[1],e)-this._node.getBottom(u[0],e),"(row[1].top - row[0].bottom)"),this._node.getTop(u[0],e)>m&&(m=_,this._debugMode&&this._debugToggler._splitTableNode&&console.log("The Row 0 goes to the 2nd page"));for(let o=0;o<u.length;o++){this._debugMode&&this._debugToggler._splitTableNode&&console.log(`%c 🟪 Check the Row # ${o}`,"color:blueviolet",[u[o]]);const s=u[o],i=this._node.getBottom(s,e)+d,r=this._node.getTop(s,e)+d,l=u[o+1];if((l?this._node.getTop(l,e)+d:i)>m){const i=o,l=s,a=this._DOM.getElementOffsetHeight(l),g=this._node.getTableRowHeight(l,this._minBreakableLines),h=this._node.getTableRowHeight(l),f=r,M=this._node.isNoBreak(l),T=a>=g&&!M;if(this._debugMode&&this._debugToggler._splitTableNode&&console.log(`%c • Row # ${o}: try to split`,"color:blueviolet"),T){this._debugMode&&this._debugToggler._splitTableRow&&console.groupCollapsed(`Split The ROW.${i}`);const e=m-f-h,s=_-h,r=this._DOM.getChildren(l);let a;a=[...r].map(((o,n)=>{const r=this._node.getPreparedChildren(o);this._debugMode&&this._debugToggler._splitTableRow&&console.groupCollapsed(`Split TD.${n} in ROW.${i}`);const l=this._getInternalBlockSplitters({rootNode:o,children:r,pageBottom:t,firstPartHeight:e,fullPageHeight:s});return this._debugMode&&this._debugToggler._splitTableRow&&console.groupEnd(`Split TD.${n} in ROW.${i}`),l})),this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣 \ntheRowContentSlicesByTD",a);const g=a.some((e=>(this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣","\nobj.result.length",e.result.length,"\nobj.result[0]",e.result[0]),e.result.length&&null===e.result[0])));this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣","\nshouldFirstPartBeSkipped",g),g&&(a=[...r].map((e=>{const o=this._node.getPreparedChildren(e);return this._getInternalBlockSplitters({rootNode:e,children:o,pageBottom:t,firstPartHeight:s,fullPageHeight:s})}))),this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣","\n theRowContentSlicesByTD",a);const d=a.some((e=>e.result.length));if(this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣 ifThereIsSplit",d),d){const e=a.map((e=>{if(e.result.length)return this._createSlicesBySplitFlag(e.trail);{const t=this._node.createWithFlagNoBreak();t.classList.add("🟣"),this._DOM.setStyles(t,{display:"contents"});const o=e.trail.map((e=>e.element));return this._DOM.insertAtEnd(t,...o),[t]}}));this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣 theTdContentElements",e);const t=Math.max(...e.map((e=>e.length)));this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣 theNewTrCount",t);const s=[];for(let o=0;o<t;o++){const t=this._DOM.cloneNodeWrapper(l);this._node.setFlagNoBreak(t),this._DOM.setAttribute(t,`.splitted_row_${i}_part_${o}`),[...r].forEach(((s,i)=>{const n=this._DOM.cloneNodeWrapper(s);e[i][o]&&this._DOM.insertAtEnd(n,e[i][o]),this._DOM.insertAtEnd(t,n)})),s.push(t)}this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣","\n theNewRows",s),this._DOM.setAttribute(l,".🚫_must_be_removed"),this._debugMode&&this._debugToggler._splitTableRow&&console.log("🟣 splittingRow",l),this._DOM.insertInsteadOf(l,...s),n.rows.splice(i,1,...s),u=p(n),o-=1}this._debugMode&&this._debugToggler._splitTableRow&&console.log(`%c END 🟪 Split The ROW.${i}`,c),this._debugMode&&this._debugToggler._splitTableRow&&console.groupEnd("END OF 'if makesSenseToSplitTheRow'")}else this._debugMode&&this._debugToggler._splitTableNode&&console.log(`%c • Row # ${o}: small or noBreak`,"color:blueviolet"),o>=this._minLeftRows&&(b.push(o),this._debugMode&&this._debugToggler._splitTableNode&&console.log(`%c • Row # ${o}: REGISTER as start, index >= ${this._minLeftRows} (_minLeftRows) `,"color:blueviolet")),m=this._node.getTop(u[o],e)+d+_}else this._debugMode&&this._debugToggler._splitTableNode&&console.log(`%c • Row # ${o}: PASS ...`,"color:blueviolet")}if(this._debugMode&&this._debugToggler._splitTableNode&&console.log(...s,"splitsIds",b),!b.length)return this._debugMode&&this._debugToggler._splitTableNode&&console.log("%c END _splitTableNode !splitsIds.length",c),this._debugMode&&this._debugToggler._splitTableNode&&console.groupEnd(),[];const f=u.length-1-this._minDanglingRows;b[b.length-1]>f&&(b[b.length-1]=f);const M=b.map(((t,o,s)=>this._insertTableSplit({startId:s[o-1]||0,endId:t,table:e,tableEntries:n})));this._debugMode&&this._debugToggler._splitTableNode&&console.log(...s,"splits",M);const T=this._node.createWithFlagNoBreak();return e.before(T),this._DOM.insertAtEnd(T,this._node.createSignpost("(table continued)",this._signpostHeight),e),this._debugMode&&this._debugToggler._splitTableNode&&console.timeEnd("_splitTableNode"),this._debugMode&&this._debugToggler._splitTableNode&&console.log("%c END _splitTableNode",c),this._debugMode&&this._debugToggler._splitTableNode&&console.groupEnd(),[...M,T]}_createSlicesBySplitFlag(e){this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.group("_createSlicesBySplitFlag");const t=this._node.createWithFlagNoBreak();this._DOM.setStyles(t,{display:"contents"}),t.classList.add("🧰");const o=[t];let s=[t],i=t;const n=e=>{if(0===e.length)return null;const t=e[0];let o=t;for(let t=1;t<e.length;t++){const s=e[t];this._DOM.insertAtEnd(o,s),o=s}return this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log(" createWrapperFromArray:",t),t},r=(e,t=null)=>{this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.group("processChildren"),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("*start* children",e);for(let t=0;t<e.length;t++)l(e[t]);this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("- wrappers BEFORE pop:",[...s]);const o=s.pop();this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("- wrappers.pop()",o),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("- parent",t),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("- wrappers AFTER pop:",[...s]),i=s.at(-1),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("🎯🎯 currentTargetInSlice",i),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("🎯 wrappers.at(-1)",s.at(-1)),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("*END* children",e),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("%c END processChildren",c),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.groupEnd()},l=e=>{const t=e.children?.length>0,l=e.split,a=e.element,g=e.id;if(this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.group(`processObj # ${g}`),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("currentElement",a),a&&this._DOM.removeNode(a),l){this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("••• hasSplitFlag"),s=s.map((e=>{const t=this._DOM.cloneNodeWrapper(e);return t.classList.add("🚩"),t})),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: NEW wrappers.map:",[...s]);const e=n(s);o.push(e),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: slices.push(nextWrapper):",[...o]),i=s.at(-1),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: currentTargetInSlice:",i)}if(t){this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("••• hasChildren");const t=this._DOM.cloneNodeWrapper(a);s.push(t),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: wrappers.push(cloneCurrentElementWrapper)",t,[...s]),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice (check):",i),i?(this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice","TRUE, add to existing",t),this._DOM.insertAtEnd(i,t)):(this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice","FALSE, init the first",t),t.classList.add("🏁first"),this._DOM.setStyles(t,{background:"yellow"}),o.push(t),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: slices.push(cloneCurrentElementWrapper)",t,[...o])),i=s.at(-1),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren:  currentTargetInSlice (=):",i),r(e.children,a)}else i=s.at(-1),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("insert currentElement",a,"to target",i),this._DOM.insertAtEnd(i,a);this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log(`%c END processObj # ${g}`,c),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.groupEnd()};return this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("#######  currentTargetInSlice (=):",i),r(e),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("slices:",o),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&o.forEach((e=>console.log("slice:",e))),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.log("%c END _createSlicesBySplitFlag",c),this._debugMode&&this._debugToggler._createSlicesBySplitFlag&&console.groupEnd(),o}_getInternalBlockSplitters({rootNode:e,rootComputedStyle:t,children:o,pageBottom:s,firstPartHeight:i,fullPageHeight:n,result:r=[],trail:l=[],indexTracker:a=[],stack:g=[]}){const d=t||this._DOM.getComputedStyle(e),h=d.position;"relative"!=h&&this._DOM.setStyles(e,{position:"relative"}),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.group("💟 _getInternalBlockSplitters");const _=e=>{e>=0?a.push(e):a.pop()},p=(e,t)=>{this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.assert(t>=0,"registerResult: ID mast be provided",e);let o,s=l[t];if(this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.groupCollapsed("💜💜💜 registerResult(element, id)"),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("\n element",e,"\n id",t,"\n theElementObject (trail[id])",s,"\n theElementIndexInStack",o),0==t){const e=(e=>{let t,o=null;for(let s=e.length-1;s>=0;s--){if(0!==e[s].id)return{item:o,index:t};o=e[s],t=s}return{item:o,index:t}})(g);this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💜💜 id == 0","\n💜 [...stack]",[...g],"\n💜 topParentElementFromStack",e),e.item&&(s=e.item,o=e.index)}this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💜","\n theElementObject",s,"\n theElementIndexInStack",o,"\n [...indexTracker]",[...a]),0===o?(r.push(null),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("result.push(null)","\n\n💜💜💜")):(r.push(s.element),s&&(s.split=!0),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("\n theElementObject",s,"\n theElementObject.element",s.element,"\n result.push(theElementObject.element)","\n\n💜💜💜 ")),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("%c END _getInternalBlockSplitters registerResult",c),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.groupEnd()};this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟 result 💟",r,"\n\n","\n rootNode:",e,"\n children:",o,"\n pageBottom:",s,"\n firstPartHeight:",i,"\n fullPageHeight:",n,"\n\n\n","💟 stack",[...g]);for(let t=0;t<o.length;t++){const h=o[t-1],c=o[t],u=o[t+1],b=u?this._node.getTop(u,e):void 0,m={id:t,element:o[t]},f={id:t+1,element:o[t+1]};t!==(l.length?l.at(-1).id:void 0)&&l.push(m);const M=0===r.length?i:null===r.at(-1)?n:n+this._node.getTop(r.at(-1),e);if(this._node.isForcedPageBreak(c)&&this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.warn(c,"💟 is isForcedPageBreak"),b<=M)this._node.isNoHanging(c)&&(this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟 currentElement _isNoHanging"),p(c,t));else{this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟",c,`nextElementTop > floater \n ${b} > ${M} `),(this._node.isSVG(c)||this._node.isIMG(c))&&this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("%cIMAGE 💟💟","color:red;text-weight:bold");const o=this._node.getBottomWithMargin(c,e);if(this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟 current ???","\n currentElement",c,"\n currentElementBottom",o,"\n floater",M),o<=M)this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟💟 currentElementBottom <= floater"),u&&(this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟💟💟 register nextElement"),l.push(f),p(u,t+1));else{this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("💟💟💟 currentElementBottom > floater,\ntry to split",c);const o=this._getProcessedChildren(c,s,n);if(o.length)_(t),g.push(m),this._getInternalBlockSplitters({rootNode:e,rootComputedStyle:d,children:o,pageBottom:s,firstPartHeight:i,fullPageHeight:n,result:r,trail:l[t].children=[],indexTracker:a,stack:g}),g.pop(),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("🟪 back from _getInternalBlockSplitters;\n trail[i]",l[t]);else if(h&&this._node.isNoHanging(h)){console.warn("tst improveResult",h);let e=h;e=this._node.findFirstChildParent(e,this._contentFlow)||e;e=this._node.findPreviousNoHangingsFromPage(e,this.pages.at(-2)?.pageBottom,this._root)||e,this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("previousElement _isNoHanging"),p(e,t-1)}else this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log(c,"currentElement has no children"),p(c,t)}}}return _(),this._DOM.setStyles(e,{position:h}),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.log("%c END _getInternalBlockSplitters",c),this._debugMode&&this._debugToggler._getInternalBlockSplitters&&console.groupEnd(),{result:r,trail:l}}_splitGridNode(e,t,o){this._debugMode&&this._debugToggler._splitGridNode&&console.group("%c_splitGridNode","background:#00FFFF");const s=this._node.getPreparedChildren(e);this._debugMode&&this._debugToggler._splitGridNode&&console.log("💠 children",s),this._debugMode&&this._debugToggler._splitGridNode&&console.groupCollapsed("make childrenGroups");const i=s.reduce(((e,t,o,s)=>{const i=this._DOM.getComputedStyle(t),n=i.getPropertyValue("grid-column-start"),r=i.getPropertyValue("grid-column-end"),l={element:t,start:"auto"===n?"auto":parseInt(i.getPropertyValue("grid-column-start")),end:"auto"===r?"auto":parseInt(i.getPropertyValue("grid-column-end")),top:this._DOM.getElementOffsetTop(t)};return!e.length||e.at(-1).at(-1).start>=l.start||"auto"===e.at(-1).at(-1).start||"auto"===l.start?(e.at(-1)&&this._node.isNoHanging(e.at(-1).at(-1).element)?(e.at(-1).push(l),this._debugMode&&this._debugToggler._splitGridNode&&console.log("Add to group (after no-hang.)",l)):(e.push([l]),this._debugMode&&this._debugToggler._splitGridNode&&console.log("Start new group:",l)),this._debugMode&&this._debugToggler._splitGridNode&&console.log("result:",[...e]),e):e.length&&e.at(-1).at(-1).start<l.start?(e.at(-1).push(l),this._debugMode&&this._debugToggler._splitGridNode&&console.log("Add to group:",l,[...e]),e):void(this._debugMode&&console.assert(!0,"_splitGridNode: An unexpected case of splitting a grid.","\nOn the element:",t))}),[]);this._debugMode&&this._debugToggler._splitGridNode&&console.groupEnd("make childrenGroups"),this._debugMode&&this._debugToggler._splitGridNode&&console.log("%c childrenGroups","font-weight:bold",i);const n=i.length,r=this._DOM.getElementOffsetHeight(e);if(n<this._minBreakableGridRows&&r<o)return this._debugMode&&this._debugToggler._splitGridNode&&console.log("%c END DONT _splitGridNode",c),this._debugMode&&this._debugToggler._splitGridNode&&console.groupEnd(),[];const l=[...i.map((e=>e.map((e=>e.top)).sort())).map((e=>e[0])),r];this._debugMode&&this._debugToggler._splitGridNode&&console.log("gridPseudoRowsTopPoints",l);const a=this._node.getTop(e,this._root),g=this._node.getEmptyNodeHeight(e),d=t-a-g,h=o-g;this._debugMode&&this._debugToggler._splitGridNode&&console.log("\n • firstPartHeight",d,"\n • fullPagePartHeight",h);const _=l;let p=[],u=d;for(let e=0;e<_.length;e++)_[e]>u&&(e>this._minLeftRows&&p.push(e-1),u=_[e-1]+h);this._debugMode&&this._debugToggler._splitGridNode&&console.log("splitsIds",p);const b=(t,o)=>{this._debugMode&&this._debugToggler._splitGridNode&&console.log(`=> insertGridSplit(${t}, ${o})`);const s=i.slice(t,o).flat().map((e=>e.element));this._debugMode&&this._debugToggler._splitGridNode&&console.log("partEntries",s);const n=this._DOM.cloneNodeWrapper(e);return this._node.copyNodeWidth(n,e),this._node.setFlagNoBreak(n),e.before(n),this._DOM.insertAtEnd(n,...s),n},m=[...p.map(((e,t,o)=>b(o[t-1]||0,e))),e];return this._debugMode&&this._debugToggler._splitGridNode&&console.log("splits",m),m.forEach(((e,t)=>this._DOM.setAttribute(e,"[part]",`${t}`))),this._node.setFlagNoBreak(e),this._debugMode&&this._debugToggler._splitGridNode&&console.log("%c END _splitGridNode",c),this._debugMode&&this._debugToggler._splitGridNode&&console.groupEnd(),m}}class p{constructor({config:e,DOM:t,node:o,selector:s,layout:i}){this._debugMode=e.debugMode,this._DOM=t,this._selector=s,this._node=o,this._frontpageTemplate=i.frontpageTemplate,this._headerTemplate=i.headerTemplate,this._footerTemplate=i.footerTemplate,this._paperBodySelector=s?.paperBody||".paperBody",this._paperHeaderSelector=s?.paperHeader||".paperHeader",this._paperFooterSelector=s?.paperFooter||".paperFooter",this._headerContentSelector=s?.headerContent||".headerContent",this._footerContentSelector=s?.footerContent||".footerContent",this._frontpageContentSelector=s?.frontpageContent||".frontpageContent",this._virtualPaperSelector=s?.virtualPaper||".virtualPaper",this._virtualPaperTopMarginSelector=s?.virtualPaperTopMargin||".virtualPaperTopMargin",this._virtualPaperBottomMarginSelector=s?.virtualPaperBottomMargin||".virtualPaperBottomMargin",this._pageNumberRootSelector=s?.pageNumberRoot||void 0,this._pageNumberCurrentSelector=s?.pageNumberCurrent||void 0,this._pageNumberTotalSelector=s?.pageNumberTotal||void 0,this._paperHeight,this._frontpageFactor,this.headerHeight,this.footerHeight,this.bodyHeight,this.bodyWidth,this._calculatePaperParams()}create({currentPage:e,totalPages:t}){const o=this._createPaperBody(this.bodyHeight),s=this._createPaperHeader(this._headerTemplate),i=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:s,body:o,footer:i,currentPage:e,totalPages:t})}createFrontpage({currentPage:e,totalPages:t}){const o=this._createFrontpageContent(this._frontpageTemplate,this._frontpageFactor),s=this._createPaperBody(this.bodyHeight,o),i=this._createPaperHeader(this._headerTemplate),n=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:i,body:s,footer:n,currentPage:e,totalPages:t})}createVirtualTopMargin(){return this._node.create(this._virtualPaperTopMarginSelector)}createVirtualBottomMargin(){return this._node.create(this._virtualPaperBottomMarginSelector)}_createPaper({header:e,body:t,footer:o,currentPage:s,totalPages:i}){const n=this._node.create(this._virtualPaperSelector);return this._DOM.insertAtEnd(n,this.createVirtualTopMargin(),e,t,o,this.createVirtualBottomMargin()),s&&i&&(this._setPageNumber(e,s,i),this._setPageNumber(o,s,i)),n}_createFrontpageContent(e,t){const o=this._node.create(this._frontpageContentSelector);return e&&this._DOM.setInnerHTML(o,e),t&&this._DOM.setStyles(o,{transform:`scale(${t})`}),o}_createPaperBody(e,t){const o=this._node.create(this._paperBodySelector);return this._DOM.setStyles(o,{height:e+"px"}),t&&this._DOM.insertAtEnd(o,t),o}_createPaperHeader(e){const t=this._node.create(this._paperHeaderSelector);if(e){const o=this._node.create(this._headerContentSelector);this._DOM.setInnerHTML(o,e),this._DOM.insertAtEnd(t,o)}return t}_createPaperFooter(e){const t=this._node.create(this._paperFooterSelector);if(e){const o=this._node.create(this._footerContentSelector);this._DOM.setInnerHTML(o,e),this._DOM.insertAtEnd(t,o)}return t}_setPageNumber(e,t,o){const s=this._pageNumberRootSelector?this._DOM.getElement(this._pageNumberRootSelector,e):this._pageNumberRootSelector;if(s){const e=this._DOM.getElement(this._pageNumberCurrentSelector,s),i=this._DOM.getElement(this._pageNumberTotalSelector,s);this._DOM.setInnerHTML(e,t),this._DOM.setInnerHTML(i,o)}}_calculatePaperParams(){const e=this._createPaperBody(),t=this._createFrontpageContent(this._frontpageTemplate),o=this._createPaperHeader(this._headerTemplate),s=this._createPaperFooter(this._footerTemplate),i=this._createPaper({header:o,body:e,footer:s}),n=this._node.create("#workbench");this._DOM.setStyles(n,{position:"absolute",left:"-3000px"}),this._DOM.insertAtEnd(n,i),this._DOM.insertAtStart(this._DOM.body,n);const r=this._DOM.getElementBCR(i).height,l=this._DOM.getElementOffsetHeight(o)||0,a=this._DOM.getElementOffsetHeight(s)||0,g=this._DOM.getElementOffsetHeight(e),d=this._DOM.getElementOffsetWidth(e);this._DOM.insertAtStart(e,t);const h=this._DOM.getElementOffsetHeight(e),c=h>g?g/h:1;this._DOM.removeNode(n),l>.2*r&&console.warn("It seems that your custom header is too high"),a>.15*r&&console.warn("It seems that your custom footer is too high"),c<1&&console.warn("It seems that your frontpage content is too large. We made it smaller to fit on the page. Check out how it looks! It might make sense to fix this with styles or reduce the text amount."),this._paperHeight=r,this.headerHeight=l,this.footerHeight=a,this.bodyHeight=g,this.bodyWidth=d,this._frontpageFactor=c}}class u{constructor({config:e,DOM:t,selector:o,node:s,pages:i,layout:n,paper:r}){this._config=e,this._debugMode=e.debugMode,this._DOM=t,this._selector=o,this._node=s,this._virtualPaperGapSelector=o.virtualPaperGap,this._runningSafetySelector=o.runningSafety,this._printPageBreakSelector=o.printPageBreak,this._pageDivider=o.pageDivider,this._virtualPaper=o.virtualPaper,this._virtualPaperTopMargin=o.virtualPaperTopMargin,this._paperBody=o.paperBody,this._pages=i,this._root=n.root,this._contentFlow=n.contentFlow,this._paperFlow=n.paperFlow,this._paper=r,this._hasFrontPage=!!n.frontpageTemplate}create(){this._processFirstPage(),this._processOtherPages(),(!0===this._config.mask||"true"===this._config.mask)&&this._addMask()}_addMask(){const e=[...this._paperFlow.querySelectorAll(this._virtualPaper)],t=this._DOM.getElementOffsetTop(e.at(-1))/(e.length-1),o=this._DOM.getElementOffsetHeight(this._paperFlow.querySelector(this._virtualPaperTopMargin)),s=this._DOM.getElementOffsetHeight(this._paperFlow.querySelector(this._paperBody));!function({targetElement:e,maskHeight:t,maskWindow:o,maskTopPosition:s}){e.style=`\n    -webkit-mask-image: linear-gradient(\n      black 0,\n      black ${o}px,\n      transparent ${o}px,\n      transparent ${t}px\n    );\n            mask-image: linear-gradient(\n              black 0,\n              black ${o}px,\n              transparent ${o}px,\n              transparent ${t}px\n            );\n    -webkit-mask-repeat: no-repeat;\n            mask-repeat: no-repeat;\n    -webkit-mask-size: 100% ${t}px;\n            mask-size: 100% ${t}px;\n    -webkit-mask-position: 100% ${s}px;\n            mask-position: 100% ${s}px;\n    -webkit-mask-repeat: repeat-y;\n            mask-repeat: repeat-y;\n    -webkit-mask-origin: border-box;\n            mask-origin: border-box;\n    `}({targetElement:this._contentFlow,maskHeight:t,maskWindow:s,maskTopPosition:o})}_processFirstPage(){let e;if(this._hasFrontPage){const t=this._insertFrontpageSpacer(this._contentFlow,this._paper.bodyHeight);this._pages.unshift({pageStart:t}),e=this._paper.createFrontpage({currentPage:1,totalPages:this._pages.length})}else e=this._paper.create({currentPage:1,totalPages:this._pages.length});this._insertIntoPaperFlow(e),this._insertIntoContentFlow(0)}_processOtherPages(){for(let e=1;e<this._pages.length;e++){const t=this._paper.create({currentPage:e+1,totalPages:this._pages.length}),o=this._createVirtualPaperGap();this._insertIntoPaperFlow(t,o),this._insertIntoContentFlow(e,o)}}_insertIntoPaperFlow(e,t){this._insertPaper(this._paperFlow,e,t)}_insertIntoContentFlow(e,t){const o=this._pages[e].pageStart,s=this._createPageBreaker(e,t);this._DOM.insertBefore(o,s),t&&this._insertFooterSpacer(s,this._paper.footerHeight,t),this._insertHeaderSpacer(s,this._paper.headerHeight),this._updatePageStartElementAttrValue(o,e)}_createPageBreaker(e,t){const o=this._node.create(this._pageDivider);return this._DOM.setAttribute(o,"[page]",`${e+1}`),t&&this._paper.footerHeight&&this._DOM.setStyles(o,{marginTop:this._paper.footerHeight-1+"px"}),this._paper.headerHeight&&this._DOM.setStyles(o,{marginBottom:this._paper.headerHeight-1+"px"}),o}_updatePageStartElementAttrValue(e,t){this._hasFrontPage&&this._node.markPageStartElement(e,`${t+1}`)}_insertPaper(e,t,o){o?this._DOM.insertAtEnd(e,o,t):this._DOM.insertAtEnd(e,t)}_createVirtualPaperGap(){return this._node.create(this._virtualPaperGapSelector)}_createVirtualPaperTopMargin(){return this._paper.createVirtualTopMargin()}_createVirtualPaperBottomMargin(){return this._paper.createVirtualBottomMargin()}_insertFrontpageSpacer(e,t){const o=this._node.create();return this._DOM.setStyles(o,{paddingBottom:t+"px"}),this._DOM.setAttribute(o,".printFrontpageSpacer"),this._DOM.insertAtStart(e,o),o}_insertHeaderSpacer(e,t){const o=this._DOM.createDocumentFragment(),s=this._node.create(this._runningSafetySelector);this._DOM.insertAtEnd(o,this._createVirtualPaperTopMargin(),s),this._DOM.insertAtEnd(e,o)}_insertFooterSpacer(e,t,o){const s=this._DOM.createDocumentFragment(),i=this._createVirtualPaperGap(),n=this._node.create(this._runningSafetySelector);this._DOM.insertAtEnd(s,n,this._createVirtualPaperBottomMargin(),this._node.create(this._printPageBreakSelector),i),this._DOM.insertAtStart(e,s),this._balanceFooter(n,i,o)}_balanceFooter(e,t,o){const s=this._node.getTop(o,this._root)-this._node.getTop(t,this._root);this._DOM.setStyles(e,{marginBottom:s+"px"}),this._debugMode&&console.assert(s>=0,`balancer is negative: ${s} < 0`,t)}}class b{constructor({config:e,DOM:t,selector:o,node:s,layout:i}){this._debugMode=e.debugMode,this._DOM=t,this._node=s,this._tocPageNumberSelector=e.tocPageNumberSelector,this._root=i.root,this._contentFlow=i.contentFlow,this._pageDividerSelector=o.pageDivider,this._debugToggler={_:!1}}render(){this._debugMode&&console.time("Processing TOC"),this._debugMode&&this._debugToggler._&&console.log(`\n📑 TOC: I am here!\n\ntocPageNumberSelector:\n • ${this._tocPageNumberSelector}\n pageDividerSelector:\n • ${this._pageDividerSelector}\n      `);const e=this._node.getAll(this._tocPageNumberSelector,this._contentFlow);if(this._debugMode&&this._debugToggler._&&console.log("📑 tocPageNumberBoxes",e.length),!e.length)return void(this._debugMode&&this._debugToggler._&&console.log("📑 no valid toc"));const t=this._node.getAll(this._pageDividerSelector,this._contentFlow).reduce(((e,t,o)=>{const s=this._node.getTop(t,this._root)-1,i=this._DOM.getAttribute(t,"[page]");return e[s]=i,e}),{});this._debugMode&&this._debugToggler._&&console.log("📑 dataFromPagesMarkers",t);const o=e.reduce(((e,t)=>{const o=this._DOM.getDataId(t),s=this._DOM.getElementById(o),i=this._node.getTop(s,this._root);return e[i]={box:t,id:o,targetTop:i},e}),{});this._debugMode&&this._debugToggler._&&console.log("📑 dataFromTOC",o);const s={...t,...o};let i=0;this._debugMode&&this._debugToggler._&&console.groupCollapsed("Processing obj");for(const e in s){const t=s[e];this._debugMode&&this._debugToggler._&&console.log(`Processing ${e}: ${t}`),"string"==typeof t?i=t:(t.page=i,this._DOM.setInnerHTML(t.box,i))}this._debugMode&&this._debugToggler._&&console.groupEnd("Processing obj"),this._debugMode&&this._debugToggler._&&console.log("📑 tocObject",s),this._debugMode&&console.timeEnd("Processing TOC")}}class m{constructor({config:e,DOM:t,selector:o}){this._config=e,this._selector=o,this._DOM=t}init(){this._config.debugMode&&console.log("🐙 i am Validator!");const e=`${this._selector.paperFlow} ${this._selector.virtualPaperGap}`,t=`${this._selector.contentFlow} ${this._selector.virtualPaperGap}`,o=[...this._DOM.getAllElements(e)].map((e=>e.offsetTop)),s=[...this._DOM.getAllElements(t)].map((e=>e.offsetTop)),i=o.reduce(((e,t,o)=>(t!==s[o]&&e.push(o+1),e)),[]);console.assert(!i.length,"Problems with preview generation on the following pages: ",i)}}const f="border:1px dashed #cccccc;background:#ffffff;color:#cccccc;";class M{constructor(e){this._debugMode=e.debugMode,this._preloader,this._preloaderTarget=document.querySelector(e.preloaderTarget)||document.body,this._preloaderBackground=e.preloaderBackground||"white"}create(){this._debugMode&&console.groupCollapsed("%c Preloader ",f),this._insertStyle(),this._preloader=document.createElement("div"),this._preloader.classList.add("lds-dual-ring"),this._preloaderTarget.append(this._preloader),this._debugMode&&console.groupEnd("%c Preloader ",f)}remove(){if(!this._preloader)return;let e=1;const t=setInterval((()=>{e<=.1&&(clearInterval(t),this._preloader.remove()),this._preloader.style.opacity=e,e-=.1*e}),50);this._debugMode&&console.log("%c Preloader removed ",f)}_insertStyle(){const e=document.querySelector("head"),t=document.createElement("style");t.append(document.createTextNode(this._css())),t.setAttribute("data-preloader-style",""),e.append(t)}_css(){return`\n    /* PRELOADER */\n    .lds-dual-ring {\n      position: absolute;\n      z-index: 99999;\n      top: 0; left: 0; bottom: 0; right: 0;\n      background: ${this._preloaderBackground};\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    }\n    /*\n    .lds-dual-ring:after {\n      content: " ";\n      display: block;\n      width: 64px;\n      height: 64px;\n      margin: 8px;\n      border-radius: 50%;\n      border: 6px solid #eee;\n      border-color: #eee transparent #eee transparent;\n      animation: lds-dual-ring 1.2s linear infinite;\n    }\n    @keyframes lds-dual-ring {\n      0% {\n        transform: rotate(0deg);\n      }\n      100% {\n        transform: rotate(360deg);\n      }\n    }\n    */\n  `}}class T{constructor(e){this._debugMode=e.debugMode}run(){let e=[...document.querySelectorAll("object")];this._debugMode&&console.log(e);let t=[];return e.forEach((e=>{const o=new Promise((t=>{e.addEventListener("load",(o=>{this._debugMode&&console.log("⏰ EVENT: object load",e.clientHeight,e.clientWidth,e),t()}))}));t.push(o)})),Promise.all(t)}}const O="color:Gray;border:1px solid;";console.info("HTML2PDF4DOC v0.0.1");const D=document.currentScript.dataset,N=new class{constructor(e){this.params=e,this.debugMode=e.debugMode,this.preloader=e.preloader,this.selector=o,this.config}async render(){console.time("⏱️ HTML2PDF4DOC time"),this.debugMode&&console.log("🏁 document.readyState",document.readyState),document.addEventListener("readystatechange",(e=>{this.debugMode&&console.log("🏁 readystatechange",document.readyState)})),this.debugMode&&console.time("⏱️ await DOMContentLoaded time"),await new Promise((e=>{window.addEventListener("DOMContentLoaded",(t=>{this.debugMode&&console.log("⏰ EVENT: DOMContentLoaded"),e()}))})),this.debugMode&&console.timeEnd("⏱️ await DOMContentLoaded time"),this.debugMode&&console.time("⏱️ create Preloader time");const e=new M(this.params);"true"===this.preloader&&e.create(),this.debugMode&&console.timeEnd("⏱️ create Preloader time"),this.debugMode&&console.time("⏱️ Config time"),this.debugMode&&console.groupCollapsed("%c config ",O+"color:LightGray"),this.config=function(e){let t={debugMode:!1,preloader:!1,preloaderTarget:"",preloaderBackground:"",mask:!1,noHangingSelectors:"",forcedPageBreakSelectors:"",pageBreakBeforeSelectors:"",pageBreakAfterSelectors:"",noBreakSelectors:"",tocPageNumberSelector:"html2pdf-toc-page-number",printLeftMargin:"21mm",printRightMargin:"21mm",printTopMargin:"12mm",printBottomMargin:"12mm",printFontSize:"12pt",printWidth:"210mm",printHeight:"297mm",headerMargin:"16px",footerMargin:"16px",virtualPagesGap:"16px"};const s={printWidth:"210mm",printHeight:"297mm"},i={printWidth:"148.5mm",printHeight:"210mm"};switch(e.printPaperSize){case"A5":case"a5":t={...t,...i};break;default:t={...t,...s}}t={...t,initialRoot:o.init,tocPageNumberSelector:o.tocPageNumber,...e},console.info("HTML2PDF4DOC config:",t);const n={printLeftMargin:t.printLeftMargin,printRightMargin:t.printRightMargin,printTopMargin:t.printTopMargin,printBottomMargin:t.printBottomMargin,printFontSize:t.printFontSize,printWidth:t.printWidth,printHeight:t.printHeight,headerMargin:t.headerMargin,footerMargin:t.footerMargin,virtualPagesGap:t.virtualPagesGap},r=document.createElement("div");return r.style="\n  position:absolute;\n  z-index:1000;\n  left: 200%;\n  ",document.body.append(r),Object.entries(n).forEach((([e,t])=>{r.style.width=t,n[e]=`${Math.trunc(r.getBoundingClientRect().width)}px`})),r.remove(),t={...t,...n},t.noHangingSelectors=t.noHangingSelectors+" H1 H2 H3 H4 H5 H6",t.forcedPageBreakSelectors=t.forcedPageBreakSelectors+" "+o.printForcedPageBreak,console.info("HTML2PDF4DOC config with converted units:",t),t}(this.params),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Config time"),this.debugMode&&console.time("⏱️ DOM helpers init time");const t=new s({DOM:window.document,debugMode:this.debugMode});this.debugMode&&console.timeEnd("⏱️ DOM helpers init time"),this.debugMode&&console.time("⏱️ node helpers init time");const i=new r({config:this.config,DOM:t,selector:this.selector});this.debugMode&&console.timeEnd("⏱️ node helpers init time"),this.debugMode&&console.time("⏱️ await window load time"),await new Promise((e=>{window.addEventListener("load",(t=>{this.debugMode&&console.log("⏰ EVENT: window load"),e()}))})),this.debugMode&&console.timeEnd("⏱️ await window load time"),this.debugMode&&console.time("⏱️ Layout time"),this.debugMode&&console.groupCollapsed("%c Layout ",O);const l=new n({config:this.config,DOM:t,selector:this.selector,node:i});if(l.create(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Layout time"),!l.success)return void(this.debugMode&&console.error("Failed to create layout.\n\nWe have to interrupt the process of creating PDF preview."));this.debugMode&&console.info("%c calculate Paper params ",O),this.debugMode&&console.time("⏱️ Paper time");const a=new p({config:this.config,DOM:t,selector:this.selector,node:i,layout:l});if(this.debugMode&&console.timeEnd("⏱️ Paper time"),!a||!a.bodyHeight||!a.bodyWidth)return void(this.debugMode&&console.error("Failed to create paper calculations.\n\nWe have to interrupt the process of creating PDF preview."));this.debugMode&&console.time("⏱️ Preprocess time"),this.debugMode&&console.groupCollapsed("%c Preprocess ",O),await new T(this.config).run(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Preprocess time"),this.debugMode&&console.time("⏱️ Pages time"),this.debugMode&&console.groupCollapsed("%c Pages ",O);const g=new _({config:this.config,DOM:t,selector:this.selector,node:i,layout:l,referenceHeight:a.bodyHeight,referenceWidth:a.bodyWidth}).calculate();this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Pages time"),this.debugMode&&console.time("⏱️ Preview time"),this.debugMode&&console.groupCollapsed("%c Preview ",O),new u({config:this.config,DOM:t,selector:this.selector,node:i,layout:l,paper:a,pages:g}).create(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Preview time"),this.debugMode&&console.time("⏱️ Toc time"),new b({config:this.config,DOM:t,selector:this.selector,node:i,layout:l}).render(),this.debugMode&&console.timeEnd("⏱️ Toc time"),this.debugMode&&console.time("⏱️ Validator time"),new m({config:this.config,DOM:t,selector:this.selector,layout:l}).init(),this.debugMode&&console.timeEnd("⏱️ Validator time"),t.setAttribute(l.root,"[success]"),e.remove(),console.timeEnd("⏱️ HTML2PDF4DOC time")}}(D),S="manual"===D.init;function P(){S&&N.render()}S&&console.info("HTML2PDF4DOC in manual initialization mode"),!S&&N.render(),HTML2PDF4DOC=t})();